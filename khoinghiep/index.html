<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover">
  <meta name="description" content="GreenFit 6.0 - Sống khỏe hữu cơ, tính BMI tự động, giỏ hàng, hóa đơn PDF, dark mode, PWA">
  <meta name="theme-color" content="#548C2F">
  <title>GreenFit 6.0 - Sống Xanh, Tập Mạnh (Upgraded)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700;900&display=swap" rel="stylesheet"> 

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <link rel="manifest" href="data:application/manifest+json,{
    \"name\":\"GreenFit 6.0\",
    \"short_name\":\"GreenFit\",
    \"start_url\":\".\",
    \"display\":\"standalone\",
    \"background_color\":\"#FCF8F2\",
    \"theme_color\":\"#548C2F\",
    \"icons\":[{\"src\":\"https://via.placeholder.com/192\",\"sizes\":\"192x192\",\"type\":\"image/png\"},{\"src\":\"https://via.placeholder.com/512\",\"sizes\":\"512x512\",\"type\":\"image/png\"}]
  }">

  <style>
    :root {
      --primary: #548C2F;
      --primary-dark: #3F6F23;
      --secondary: #E3F2FD;
      --hot: #E74C3C;
      --text: #333333;
      --bg: #FCF8F2;
      --card-bg: #FFFFFF;
      --glass: rgba(255, 255, 255, 0.7);
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      --gray: #6B7280;
      --transition: all 0.3s ease-in-out;
    }

    [data-theme="dark"] {
      --text: #F3F4F6;
      --bg: #1F2937;
      --card-bg: #374151;
      --glass: rgba(55, 65, 81, 0.7);
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      --gray: #9CA3AF;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Inter', sans-serif; 
      background-color: var(--bg); 
      color: var(--text); 
      transition: var(--transition);
      scroll-behavior: smooth;
    }
    
    /* Utility */
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    .section-title { 
      text-align: center; 
      margin-bottom: 40px; 
      font-size: 2.5rem; 
      color: var(--primary-dark); 
      font-weight: 800;
      padding-top: 20px;
      font-family: 'Merriweather', serif; /* Nâng cấp: Sử dụng font Serif cho tiêu đề */
    }
    
    /* Header & Nav */
    header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background-color: var(--glass);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      padding: 10px 0;
      transition: var(--transition);
    }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 1.8rem;
      font-weight: 900;
      color: var(--primary);
      text-decoration: none;
    }
    .nav-links {
      display: flex;
      gap: 20px;
    }
    .nav-links a {
      color: var(--text);
      text-decoration: none;
      font-weight: 600;
      padding: 5px 10px;
      border-radius: 6px;
      transition: var(--transition);
    }
    .nav-links a:hover {
      color: var(--primary);
    }
    .cart-toggle-group {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .cart-icon {
      position: relative;
      font-size: 1.5rem;
      color: var(--primary);
      cursor: pointer;
    }
    .cart-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: var(--hot);
      color: white;
      font-size: 0.7rem;
      border-radius: 50%;
      padding: 2px 6px;
      font-weight: 700;
    }
    
    /* Mobile Menu */
    .menu-toggle { display: none; font-size: 1.5rem; cursor: pointer; color: var(--text); }
    @media (max-width: 768px) {
      .nav-links {
        display: none;
        flex-direction: column;
        position: absolute;
        top: 60px;
        left: 0;
        width: 100%;
        background-color: var(--card-bg);
        box-shadow: var(--shadow);
        padding: 15px 20px;
        z-index: 999;
      }
      .nav-links.active { display: flex; }
      .nav-links a { width: 100%; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.1); }
      .menu-toggle { display: block; }
    }
    
    /* Scroll Indicator */
    #scrollIndicator {
      position: fixed;
      top: 0;
      left: 0;
      height: 4px;
      background-color: var(--primary);
      z-index: 1001;
      width: 0%;
    }
    
    /* Hero Section */
    .hero {
      /* Nâng cấp: Background sử dụng màu sắc chủ đạo và ảnh tượng trưng */
      /* SỬA LỖI: Thay ảnh Unsplash bằng Picsum để tăng độ ổn định */
      background: linear-gradient(rgba(252, 248, 242, 0.7), rgba(252, 248, 242, 0.7)), url('https://picsum.photos/seed/greenfit/1400/500') no-repeat center center/cover;
      height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--text);
    }
    .hero-content h1 { font-size: 3rem; margin-bottom: 10px; color: var(--primary-dark); }
    .hero-content p { font-size: 1.2rem; margin-bottom: 30px; }
    .btn-primary {
      background-color: var(--primary);
      color: white;
      padding: 12px 25px;
      border-radius: 50px;
      text-decoration: none;
      font-weight: 600;
      transition: var(--transition);
      border: none;
      cursor: pointer;
    }
    .btn-primary:hover { background-color: var(--primary-dark); }

    /* Nâng cấp: About Section */
    #about {
        padding: 60px 0;
        text-align: center;
    }
    .about-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 30px;
        margin-top: 30px;
    }
    .mission-card {
        background-color: var(--card-bg);
        padding: 30px;
        border-radius: 15px;
        box-shadow: var(--shadow);
        transition: var(--transition);
        border-left: 5px solid var(--primary);
    }
    .mission-card i {
        font-size: 2.5rem;
        color: var(--primary);
        margin-bottom: 15px;
    }
    .mission-card h4 {
        font-size: 1.4rem;
        margin-bottom: 10px;
        color: var(--primary-dark);
    }
    
    /* BMI Calculator */
    #bmi {
      background-color: var(--secondary);
      padding: 50px 0;
      text-align: center;
    }
    .bmi-calc {
      background-color: var(--card-bg);
      padding: 40px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      max-width: 600px;
      margin: 0 auto;
    }
    .input-group {
      position: relative;
      margin-bottom: 25px;
    }
    .input-group input {
      width: 100%;
      padding: 14px 14px 14px 45px; /* Tăng padding trái */
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: var(--bg);
      color: var(--text);
      font-size: 1rem;
      transition: var(--transition);
    }
    .input-group label {
      position: absolute;
      top: 14px;
      left: 40px; /* Điều chỉnh vị trí */
      color: var(--gray);
      transition: var(--transition);
      pointer-events: none;
      background: var(--bg);
      padding: 0 5px;
    }
    .input-group input:focus + label,
    .input-group input:not(:placeholder-shown) + label {
      top: -10px;
      left: 35px;
      font-size: 0.75rem;
      color: var(--primary);
    }
    .input-group i {
      position: absolute;
      top: 16px;
      left: 14px; /* Đặt icon bên trái */
      color: var(--gray);
      transition: var(--transition);
    }
    .input-group input:focus ~ i { color: var(--primary); }
    .input-group input:focus { border-color: var(--primary); }
    
    #bmiResult {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      display: none;
      animation: slideDown 0.5s;
    }
    #bmiResult small { 
      display: block; 
      margin-top: 6px; 
      font-size: 0.95rem; 
      line-height: 1.5; 
    }
    #bmiHistory {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 15px;
      text-align: left;
      display: none;
    }
    .bmi-item {
      padding: 8px 0;
      border-bottom: 1px dashed #eee;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Products Section */
    #products { padding: 50px 0; }
    .search-filters {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      align-items: center;
      flex-wrap: wrap;
      background: var(--card-bg);
      padding: 20px;
      border-radius: 15px;
      box-shadow: var(--shadow);
    }
    .filter-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .filter-buttons button {
      background-color: var(--secondary);
      color: var(--text);
      padding: 8px 15px;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }
    .filter-buttons button.active, .filter-buttons button:hover {
      background-color: var(--primary);
      color: white;
    }
    .search-filters input, .search-filters select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: var(--bg);
      color: var(--text);
      transition: var(--transition);
    }
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 30px;
    }
    .product-card {
      background-color: var(--card-bg);
      border-radius: 15px;
      box-shadow: var(--shadow);
      overflow: hidden;
      text-align: center;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .product-card:hover {
      transform: translateY(-5px); /* Giảm độ chuyển động */
      box-shadow: 0 18px 40px rgba(0,0,0,0.12);
    }
    .product-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    .product-info {
      padding: 15px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    .product-info h3 {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: var(--primary-dark);
    }
    .price {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--hot);
      margin-bottom: 10px;
    }
    .rating {
      color: #FFD700;
      margin-bottom: 10px;
    }
    .btn-add-cart {
      background-color: var(--primary);
      color: white;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      margin-top: auto;
    }
    .btn-add-cart:hover {
      background-color: var(--primary-dark);
    }
    .btn-add-cart[disabled] { 
        background: var(--gray) !important; 
        cursor: not-allowed; 
        opacity: 0.8;
    }
    #noResults {
      text-align: center;
      grid-column: 1 / -1;
      padding: 30px;
      color: var(--gray);
      font-size: 1.2rem;
    }

    /* Nâng cấp: Testimonials Section */
    #testimonials {
        padding: 50px 0;
        background-color: var(--secondary);
    }
    .testimonial-grid {
        display: flex;
        overflow-x: auto;
        gap: 20px;
        padding-bottom: 15px;
        scroll-snap-type: x mandatory;
    }
    .testimonial-card {
        flex: 0 0 350px; /* Cố định kích thước card */
        scroll-snap-align: start;
        background-color: var(--card-bg);
        padding: 25px;
        border-radius: 15px;
        box-shadow: var(--shadow);
        min-height: 200px;
    }
    .testimonial-card blockquote {
        font-style: italic;
        color: var(--gray);
        margin-bottom: 15px;
        line-height: 1.6;
        position: relative;
        padding-left: 20px;
    }
    .testimonial-card blockquote::before {
        content: '“';
        font-size: 2rem;
        color: var(--primary);
        position: absolute;
        left: 0;
        top: -5px;
    }
    .client-info {
        display: flex;
        align-items: center;
        margin-top: 15px;
    }
    .client-info img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 15px;
    }
    .client-info strong {
        display: block;
        color: var(--primary-dark);
    }

    /* Nâng cấp: Newsletter Section */
    #newsletter {
        padding: 50px 0;
        text-align: center;
        background: linear-gradient(to right, var(--primary) 0%, #7CB74A 100%);
        color: white;
    }
    #newsletter .container {
        max-width: 800px;
    }
    #newsletter h3 {
        font-size: 2rem;
        margin-bottom: 10px;
        font-family: 'Merriweather', serif;
    }
    #newsletter p {
        font-size: 1.1rem;
        margin-bottom: 20px;
    }
    .newsletter-form {
        display: flex;
        max-width: 500px;
        margin: 0 auto;
        border-radius: 50px;
        overflow: hidden;
        background: white;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .newsletter-form input {
        flex-grow: 1;
        padding: 15px 20px;
        border: none;
        outline: none;
        font-size: 1rem;
        color: var(--text);
    }
    .newsletter-form button {
        background-color: var(--primary-dark);
        color: white;
        padding: 15px 25px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .newsletter-form button:hover {
        background-color: #3F6F23; /* Darker shade of primary-dark */
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: var(--card-bg);
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      position: relative;
      box-shadow: var(--shadow);
    }
    .close-modal {
      color: var(--gray);
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .cart-total {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid var(--primary);
        font-size: 1.3rem;
        font-weight: 700;
        text-align: right;
        color: var(--primary-dark);
    }
    
    /* Blog/Footer */
    #blog, footer { padding: 50px 0; }
    #blog { background-color: var(--secondary); }
    .blog-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
    }
    .blog-post {
      background-color: var(--card-bg);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }
    .blog-post:hover { transform: translateY(-5px); }
    .blog-post img { width: 100%; height: 200px; object-fit: cover; }
    .post-content { padding: 15px; }
    .post-content h4 { color: var(--primary-dark); margin-bottom: 10px; }
    .post-content p { font-size: 0.9rem; color: var(--gray); }

    footer {
      background-color: var(--primary-dark);
      color: white;
      text-align: center;
    }
    .footer-content {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .footer-section {
      width: 30%;
      min-width: 250px;
      margin-bottom: 20px;
      text-align: left;
    }
    .footer-section h4 { border-bottom: 2px solid white; padding-bottom: 10px; margin-bottom: 10px; }
    .social-links a { 
      color: white; 
      font-size: 1.5rem; 
      margin-right: 15px; 
      transition: var(--transition);
    }
    .social-links a:hover { color: var(--secondary); }
    
    /* Chatbot */
    #chatbot {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    #chat-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 1.8rem;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    #chat-window {
      background-color: var(--card-bg);
      border-radius: 15px;
      box-shadow: var(--shadow);
      width: 300px;
      height: 400px;
      position: absolute;
      bottom: 70px;
      right: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--primary);
      display: none;
    }
    #chat-header {
      background-color: var(--primary);
      color: white;
      padding: 10px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #chat-body {
      flex-grow: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 12px;
      line-height: 1.4;
      font-size: 0.9rem;
    }
    .user-message {
      background-color: var(--primary);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .bot-message {
      background-color: var(--secondary);
      color: var(--text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    #chat-input-area {
      padding: 10px;
      display: flex;
      border-top: 1px solid #ddd;
    }
    #chatInput {
      flex-grow: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-right: 10px;
      background-color: var(--bg);
      color: var(--text);
    }
    #chat-input-area button {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
    }

    /* Additional Enhancements */
    #scrollToTopBtn {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 100px; /* Đặt xa chatbot một chút */
        z-index: 99;
        border: none;
        outline: none;
        background-color: var(--primary-dark);
        color: white;
        cursor: pointer;
        padding: 15px;
        border-radius: 50%;
        font-size: 1.1rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: opacity 0.3s, background-color 0.3s;
    }
    #scrollToTopBtn:hover { background-color: var(--primary); }

    /* Cart Modal Styling */
    .cart-item {
        display: grid;
        grid-template-columns: 60px 2fr 1fr 60px; /* Thêm cột cho số lượng và giá */
        gap: 15px;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        align-items: center;
    }
    .cart-item img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
    }
    .cart-item-details strong {
        display: block;
        color: var(--primary-dark);
        font-size: 1rem;
        margin-bottom: 3px;
    }
    .cart-item-details small {
        color: var(--gray);
        font-size: 0.85rem;
    }
    .qty-control {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
    }
    .qty-control button {
        background: var(--secondary);
        border: 1px solid #ddd;
        width: 25px;
        height: 25px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.2s;
    }
    .qty-control button:hover {
        background: var(--primary);
        color: white;
    }
    .cart-item > div:last-child {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        justify-content: center;
    }
    .cart-item .cart-remove-btn {
        background: none;
        border: none;
        color: var(--hot);
        font-size: 1.1rem;
        cursor: pointer;
        margin-top: 5px;
    }
    
    /* Toast Notification */
    #toastNotification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translate(-50%, 0);
        background-color: #333;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
        min-width: 250px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    #toastNotification.show {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -10px);
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
      .search-filters {
        flex-direction: column;
        align-items: stretch;
      }
      .filter-buttons {
        justify-content: center;
      }
      .cart-item {
        grid-template-columns: 40px 1.5fr 1fr 50px;
      }
      .cart-item img {
        width: 40px;
        height: 40px;
      }
      .cart-item-details strong {
        font-size: 0.9rem;
      }
      /* Giảm kích thước và vị trí của nút cuộn lên đầu và chatbot */
      #scrollToTopBtn {
        width: 40px;
        height: 40px;
        bottom: 80px;
        right: 15px;
        font-size: 1rem;
      }
      #chat-btn {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
      }
      /* CSS MỚI: Dành cho chức năng Mobile View Mockup */
#viewToggle {
  position: fixed;
  bottom: 20px;
  right: 180px; /* Đặt xa Chatbot và Scroll to Top một chút */
  z-index: 100;
  background-color: var(--hot);
  color: white;
  border: none;
  border-radius: 50px;
  padding: 10px 15px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  transition: background-color 0.3s;
}
#viewToggle:hover {
  background-color: #C0392B; /* Darker red */
}

/* Container cho Mockup Mobile View */
.mobile-mockup-container {
  /* Cố định kích thước và vị trí để giả lập điện thoại */
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 375px; /* Chiều rộng điện thoại phổ biến */
  height: 812px; /* Chiều cao điện thoại phổ biến */
  max-width: 100vw;
  max-height: 100vh;
  box-shadow: 0 0 0 10000px rgba(0, 0, 0, 0.5); /* Lớp phủ mờ nền */
  border-radius: 30px;
  overflow: hidden;
  z-index: 9999;
  border: 10px solid #333;
  transition: all 0.5s ease-in-out;
}

/* Áp dụng thay đổi kích thước và tỉ lệ cho body khi ở Mobile View */
.mobile-view body {
  width: 375px;
  height: 812px;
  margin: 0;
  padding: 0;
  overflow-y: scroll;
}
    }
  </style>
</head>
<body onscroll="app.scrollHandler()">
  <div id="scrollIndicator"></div>

  <header>
    <div class="container">
      <nav class="navbar">
        <a href="#hero" class="logo">GreenFit 6.0</a>
        
        <div class="menu-toggle" onclick="app.toggleMobileMenu()">
            <i class="fas fa-bars"></i>
        </div>

        <div class="nav-links" id="mobileMenu">
          <a href="#about">Về chúng tôi</a>
          <a href="#bmi">Tính BMI</a>
          <a href="#products">Sản phẩm</a>
          <a href="#blog">Blog</a>
          <a href="#newsletter">Đăng ký</a>
        </div>
        
        <div class="cart-toggle-group">
            <button class="btn-primary" id="authBtn" onclick="app.handleAuthClick()"><i class="fas fa-user"></i></button>
            <div class="cart-icon" onclick="app.toggleCart()">
              <i class="fas fa-shopping-cart"></i>
              <span class="cart-count" id="cartCount">0</span>
            </div>
            <button class="btn-primary" id="themeToggleBtn" onclick="app.toggleTheme()" style="width:40px;height:40px;border-radius:50%;padding:0;">
                <i class="fas fa-moon"></i>
            </button>
        </div>
      </nav>
    </div>
  </header>

  <main>
    <section class="hero" id="hero">
      <div class="container hero-content">
        <h1>Sống Xanh, Tập Mạnh (Upgraded)</h1>
        <p>Lối sống hữu cơ, tính toán BMI thông minh, và mọi thứ bạn cần cho một cơ thể khỏe mạnh.</p>
        <a href="#products" class="btn-primary">Khám phá ngay</a>
      </div>
    </section>

    <section id="about">
        <div class="container">
            <h2 class="section-title">Giá Trị Cốt Lõi</h2>
            <div class="about-grid">
                <div class="mission-card">
                    <i class="fas fa-leaf"></i>
                    <h4>Sản phẩm Hữu cơ</h4>
                    <p>Cam kết 100% nguyên liệu tự nhiên, không chất bảo quản hay phụ gia độc hại.</p>
                </div>
                <div class="mission-card">
                    <i class="fas fa-heartbeat"></i>
                    <h4>Sức Khỏe Toàn Diện</h4>
                    <p>Không chỉ là dinh dưỡng, chúng tôi còn cung cấp công cụ và kiến thức tập luyện.</p>
                </div>
                <div class="mission-card">
                    <i class="fas fa-recycle"></i>
                    <h4>Bền Vững Môi Trường</h4>
                    <p>Sử dụng bao bì thân thiện với môi trường, đóng góp vào tương lai xanh hơn.</p>
                </div>
            </div>
        </div>
    </section>

    <section id="bmi">
      <div class="container">
        <h2 class="section-title">Tính chỉ số BMI</h2>
        <div class="bmi-calc">
          <p>Nhập chiều cao và cân nặng để tính BMI của bạn:</p>
          <div class="input-group">
            <input id="height" type="number" min="100" max="250" required placeholder=" ">
            <label for="height">Chiều cao</label>
            <i class="fa-solid fa-ruler"></i>
            <span style="position:absolute; right:14px; top:16px; color:var(--gray)">cm</span>
          </div>
          <div class="input-group">
            <input id="weight" type="number" min="30" max="200" required placeholder=" ">
            <label for="weight">Cân nặng</label>
            <i class="fa-solid fa-weight-scale"></i>
            <span style="position:absolute; right:14px; top:16px; color:var(--gray)">kg</span>
          </div>
          <button class="btn-primary" id="calcBtn" onclick="app.calculateBMI(true)">Tính BMI</button>
          <div id="bmiResult"></div>
          <div id="recommendations"></div>
          <div id="bmiHistory">
            <h4>Lịch sử BMI (5 mục gần nhất):</h4>
            <div id="bmiHistoryList"></div>
            <small style="color:var(--gray)">Đăng nhập để lưu lịch sử</small>
          </div>
        </div>
      </div>
    </section>

    <section id="products">
      <div class="container">
        <h2 class="section-title">Sản Phẩm Hữu Cơ</h2>
        <div class="search-filters">
          <input type="text" id="searchInput" placeholder="Tìm kiếm sản phẩm..." style="flex-grow: 1;">
          
          <div class="filter-buttons">
            <button onclick="app.filterByCategory('All')" class="active">Tất cả</button>
            <button onclick="app.filterByCategory('Food')">Thực phẩm</button>
            <button onclick="app.filterByCategory('Drink')">Đồ uống</button>
            <button onclick="app.filterByCategory('Gear')">Dụng cụ</button>
          </div>
          
          <select id="priceFilter" title="Lọc theo giá">
            <option value="All">Lọc theo Giá</option>
            <option value="Low">Dưới 100K</option>
            <option value="Medium">100K - 500K</option>
            <option value="High">Trên 500K</option>
          </select>
          
          <select id="ratingFilter" title="Lọc theo đánh giá">
            <option value="All">Lọc theo Đánh giá</option>
            <option value="4+">4 Sao trở lên</option>
            <option value="3+">3 Sao trở lên</option>
          </select>
          <button onclick="app.clearFilters()" style="background-color: var(--hot); color: white; padding: 10px; border-radius: 8px; border: none; font-weight: 600;">Xóa bộ lọc</button>
        </div>

        <div class="product-grid" id="productGrid">
          <p id="noResults" style="display: none;">Không tìm thấy sản phẩm nào phù hợp.</p>
          </div>
      </div>
    </section>

    <section id="testimonials">
        <div class="container">
            <h2 class="section-title">Khách Hàng Nói Gì</h2>
            <div class="testimonial-grid">
                <div class="testimonial-card">
                    <div class="rating">⭐⭐⭐⭐⭐</div>
                    <blockquote>"Tôi rất hài lòng với chất lượng sản phẩm hữu cơ tại GreenFit. Giá cả phải chăng, giao hàng nhanh và đặc biệt là cải thiện sức khỏe rõ rệt sau 2 tháng sử dụng."</blockquote>
                    <div class="client-info">
                        <img src="https://via.placeholder.com/50/548C2F?text=N" alt="Nguyen Van A">
                        <div>
                            <strong>Nguyễn Văn A</strong>
                            <small>Doanh nhân</small>
                        </div>
                    </div>
                </div>
                <div class="testimonial-card">
                    <div class="rating">⭐⭐⭐⭐</div>
                    <blockquote>"Chức năng tính BMI và gợi ý sản phẩm rất tiện lợi. Tôi đã giảm được 3kg nhờ kết hợp thực đơn và bài tập mà GreenFit chia sẻ trên blog."</blockquote>
                    <div class="client-info">
                        <img src="https://via.placeholder.com/50/E74C3C?text=H" alt="Hoang Thi D">
                        <div>
                            <strong>Hoàng Thu Lan</strong>
                            <small>Nội trợ</small>
                        </div>
                    </div>
                </div>
                <div class="testimonial-card">
                    <div class="rating">⭐⭐⭐⭐⭐</div>
                    <blockquote>"Giao diện tối (Dark Mode) rất đẹp và dễ sử dụng vào buổi tối. Ứng dụng PWA giúp tôi truy cập nhanh chóng như một ứng dụng gốc."</blockquote>
                    <div class="client-info">
                        <img src="https://via.placeholder.com/50/374151?text=T" alt="Tran Thi L">
                        <div>
                            <strong>Trần Minh T</strong>
                            <small>Lập trình viên</small>
                        </div>
                    </div>
                </div>
            </div>
            <p style="margin-top: 30px; color:var(--gray)">Vuốt sang phải để xem thêm đánh giá &rarr;</p>
        </div>
    </section>
    
    <section id="blog">
      <div class="container">
        <h2 class="section-title">Kiến Thức Sống Xanh</h2>
        <div class="blog-grid">
          <div class="blog-post">
            <img src="https://picsum.photos/seed/brownriceblog/300/200" alt="Lợi ích của Gạo Lứt"> 
            <div class="post-content">
              <h4>5 lợi ích không ngờ của Gạo Lứt</h4>
              <p>Gạo lứt không chỉ là thực phẩm giảm cân mà còn mang lại nhiều lợi ích sức khỏe khác...</p>
              <a href="/blog/loi-ich-gao-lut" style="color:var(--primary);font-weight:600">Đọc thêm &rarr;</a> 
            </div>
          </div>
          <div class="blog-post">
            <img src="https://picsum.photos/seed/hiitblog/300/200" alt="Các bài tập HIIT">
            <div class="post-content">
              <h4>HIIT: Tập luyện cường độ cao trong 15 phút</h4>
              <p>Các bài tập cường độ cao ngắt quãng giúp đốt cháy calo nhanh chóng và hiệu quả...</p>
              <a href="/blog/bai-tap-hiit" style="color:var(--primary);font-weight:600">Đọc thêm &rarr;</a>
            </div>
          </div>
          <div class="blog-post">
            <img src="https://picsum.photos/seed/detoxblog/300/200" alt="Detox tại nhà">
            <div class="post-content">
              <h4>3 công thức nước Detox đơn giản tại nhà</h4>
              <p>Công thức nước detox giúp làm sạch cơ thể, tăng cường năng lượng và da sáng mịn...</p>
              <a href="/blog/detox-tai-nha" style="color:var(--primary);font-weight:600">Đọc thêm &rarr;</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="newsletter">
        <div class="container">
            <h3>Đăng Ký Nhận Bản Tin Sống Xanh</h3>
            <p>Nhận ngay bí quyết dinh dưỡng, bài tập mới nhất và ưu đãi độc quyền từ GreenFit 6.0!</p>
            <form class="newsletter-form" onsubmit="event.preventDefault(); app.subscribeNewsletter()">
                <input type="email" id="newsletterEmail" placeholder="Nhập địa chỉ email của bạn..." required>
                <button type="submit">Đăng ký</button>
            </form>
        </div>
    </section>

  </main>

  <footer>
    <div class="container footer-content">
      <div class="footer-section">
        <h4>GreenFit 6.0</h4>
        <p>Sứ mệnh của chúng tôi là truyền cảm hứng cho một lối sống khỏe mạnh và bền vững thông qua các sản phẩm hữu cơ chất lượng cao.</p>
      </div>
      <div class="footer-section">
        <h4>Liên kết Nhanh</h4>
        <p><a href="#products" style="color:white;text-decoration:none;">Sản phẩm</a></p>
        <p><a href="#bmi" style="color:white;text-decoration:none;">Tính BMI</a></p>
        <p><a href="#blog" style="color:white;text-decoration:none;">Blog Kiến thức</a></p>
        <p><a href="#about" style="color:white;text-decoration:none;">Về chúng tôi</a></p>
      </div>
      <div class="footer-section">
        <h4>Theo dõi chúng tôi</h4>
        <div class="social-links">
          <a href="#"><i class="fab fa-facebook-f"></i></a>
          <a href="#"><i class="fab fa-instagram"></i></a>
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-youtube"></i></a>
        </div>
        <p style="margin-top: 15px;">Email: support@greenfit.vn</p>
        <p>Hotline: 1900 6789</p>
      </div>
    </div>
    <div style="padding: 10px 0; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">© 2025 GreenFit 6.0. All rights reserved.</div>
  </footer>

  <div id="cartModal" class="modal" onclick="if(event.target.id==='cartModal') app.closeModal('cart')">
    <div class="modal-content" id="cartModalContent">
      </div>
  </div>

  <div id="productModal" class="modal" onclick="if(event.target.id==='productModal') app.closeModal('product')">
    <div class="modal-content" id="productModalContent">
      </div>
  </div>
  
  <div id="authModal" class="modal" onclick="if(event.target.id==='authModal') app.closeModal('auth')">
    <div class="modal-content" id="authModalContent">
      </div>
  </div>

  <button onclick="app.scrollToTop()" id="scrollToTopBtn" title="Lên đầu trang">
    <i class="fas fa-arrow-up"></i>
  </button>

  <div id="toastNotification"></div>

  <div id="chatbot">
    <button id="chat-btn" onclick="app.toggleChat()"><i class="fas fa-robot"></i></button>
    <div id="chat-window">
      <div id="chat-header">
        GreenFit AI - Hỏi đáp 24/7
        <button onclick="app.toggleChat()" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;">&times;</button>
      </div>
      <div id="chat-body">
        <div class="message bot-message"><strong>AI:</strong> Chào bạn, tôi là GreenFit AI. Tôi có thể giúp gì cho bạn về dinh dưỡng, tập luyện hay sản phẩm?</div>
      </div>
      <div id="chat-input-area">
        <input type="text" id="chatInput" placeholder="Nhập tin nhắn..." onkeyup="if(event.keyCode===13) app.sendMessage()">
        <button onclick="app.sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>
  <button id="viewToggle" onclick="app.toggleViewMode()">
    <i class="fas fa-mobile-alt"></i> Mobile View
  </button>

  <script>
    const app = (() => {
      // 1. Dữ liệu (State)
      let cart = JSON.parse(localStorage.getItem('gf_cart')) || [];
      const productsData = [
        // SỬA LỖI: Cập nhật URL ảnh bằng Picsum
        { id: 1, name: 'Nước Detox Cải Bó Xôi', category: 'Drink', price: 45000, img: 'https://picsum.photos/seed/detox/250/200', rating: 4.8, stock: 15, details: 'Giúp thanh lọc cơ thể, giàu vitamin A và C.' },
        { id: 2, name: 'Gạo Lứt Hữu Cơ 1kg', category: 'Food', price: 79000, img: 'https://picsum.photos/seed/rice/250/200', rating: 4.5, stock: 0, details: 'Nguyên hạt, giàu chất xơ, tốt cho tim mạch.' },
        { id: 3, name: 'Ngũ Cốc Ăn Kiêng', category: 'Food', price: 125000, img: 'https://picsum.photos/seed/cereal/250/200', rating: 4.9, stock: 22, details: 'Thay thế bữa ăn, cung cấp đầy đủ dinh dưỡng.' },
        { id: 4, name: 'Thảm Tập Yoga TPE', category: 'Gear', price: 350000, img: 'https://picsum.photos/seed/yoga/250/200', rating: 4.2, stock: 8, details: 'Chất liệu TPE cao cấp, chống trượt tuyệt đối.' },
        { id: 5, name: 'Whey Protein Organic', category: 'Drink', price: 750000, img: 'https://picsum.photos/seed/protein/250/200', rating: 4.7, stock: 5, details: 'Protein tinh khiết từ thực vật, không biến đổi gen.' },
        { id: 6, name: 'Hạt Chia Úc 500g', category: 'Food', price: 95000, img: 'https://picsum.photos/seed/chia/250/200', rating: 4.6, stock: 30, details: 'Giàu Omega-3, hỗ trợ tiêu hóa và giảm cân.' },
        { id: 7, name: 'Bình Nước Thủy Tinh', category: 'Gear', price: 85000, img: 'https://picsum.photos/seed/bottle/250/200', rating: 4.3, stock: 18, details: 'Thủy tinh borosilicate, chịu nhiệt và bền bỉ.' },
        { id: 8, name: 'Táo Hữu Cơ Mỹ 1kg', category: 'Food', price: 110000, img: 'https://picsum.photos/seed/apple/250/200', rating: 5.0, stock: 12, details: 'Táo tươi ngon, được trồng theo tiêu chuẩn hữu cơ.' }
      ];
      let users = JSON.parse(localStorage.getItem('gf_users')) || {
          'test@greenfit.vn': { name: 'Khách Hàng Thử Nghiệm', pass: '123456', bmi: [] }
      };
      let currentUser = localStorage.getItem('gf_user');
      let currentCategory = 'All';
      let searchTimeout;

      // 2. Element Selectors (Cached)
      const els = {
        cartCount: document.getElementById('cartCount'),
        cartModal: document.getElementById('cartModal'),
        cartModalContent: document.getElementById('cartModalContent'),
        productGrid: document.getElementById('productGrid'),
        noResults: document.getElementById('noResults'),
        productModal: document.getElementById('productModal'),
        productModalContent: document.getElementById('productModalContent'),
        chatWindow: document.getElementById('chat-window'),
        chatBody: document.getElementById('chat-body'),
        chatInput: document.getElementById('chatInput'),
        heightInput: document.getElementById('height'),
        weightInput: document.getElementById('weight'),
        bmiResult: document.getElementById('bmiResult'),
        recommendations: document.getElementById('recommendations'),
        themeToggleBtn: document.getElementById('themeToggleBtn'),
        mobileMenu: document.getElementById('mobileMenu'),
        scrollToTopBtn: document.getElementById('scrollToTopBtn'),
        toastNotification: document.getElementById('toastNotification'),
        searchInput: document.getElementById('searchInput'),
        priceFilter: document.getElementById('priceFilter'),
        ratingFilter: document.getElementById('ratingFilter'),
        authModal: document.getElementById('authModal'),
        authModalContent: document.getElementById('authModalContent'),
        authBtn: document.getElementById('authBtn')
      };

      // 3. Helper Functions
      const load = (key) => JSON.parse(localStorage.getItem(key));
      const save = (key, data) => localStorage.setItem(key, JSON.stringify(data));
      const saveProducts = () => save('gf_products', productsData);
      const updateCartUI = () => els.cartCount.textContent = cart.length;

      // HÀM NÂNG CẤP: Toast Notification
      const showToast = (message) => {
        els.toastNotification.textContent = message;
        els.toastNotification.classList.add('show');
        setTimeout(() => {
          els.toastNotification.classList.remove('show');
        }, 3000);
      };

      const updateAuthUI = () => {
        if (currentUser) {
          const user = users[currentUser];
          els.authBtn.classList.add('logged-in');
          els.authBtn.innerHTML = user.name.split(' ')[0];
        } else {
          els.authBtn.classList.remove('logged-in');
          els.authBtn.innerHTML = '<i class="fas fa-user"></i>';
        }
      };

      // 4. Product Functions
      const renderProducts = (products) => {
        els.productGrid.innerHTML = '';
        if (products.length === 0) {
          els.noResults.style.display = 'block';
          return;
        }
        els.noResults.style.display = 'none';

        products.forEach(p => {
          const card = document.createElement('div');
          card.className = 'product-card';
          const ratingStars = '⭐'.repeat(Math.round(p.rating));
          const isOutOfStock = p.stock <= 0;
          
          card.innerHTML = `
            <img src="${p.img}" alt="${p.name}" loading="lazy" onclick="app.showProduct(${p.id})">
            <div class="product-info">
              <h3>${p.name}</h3>
              <div class="rating">${ratingStars} (${p.rating})</div>
              <div class="price">${p.price.toLocaleString('vi-VN')} VNĐ</div>
              ${isOutOfStock ? 
                `<button class="btn-add-cart" disabled>Hết hàng</button>` :
                `<button class="btn-add-cart" onclick="app.addToCart(${p.id})">Thêm vào giỏ</button>`
              }
            </div>
          `;
          els.productGrid.appendChild(card);
        });
      };

      const showProduct = (id) => {
        const product = productsData.find(p => p.id === id);
        if (!product) return;

        const ratingStars = '⭐'.repeat(Math.round(product.rating));
        const isOutOfStock = product.stock <= 0;

        els.productModalContent.innerHTML = `
          <span class="close-modal" onclick="app.closeModal('product')">&times;</span>
          <div style="display:flex; gap:20px; align-items:flex-start;">
            <img src="${product.img}" alt="${product.name}" style="width:150px; height:150px; object-fit:cover; border-radius:8px;">
            <div>
              <h2 style="color:var(--primary-dark); margin-top:0;">${product.name}</h2>
              <div class="rating" style="margin-bottom:10px;">${ratingStars} (${product.rating} sao)</div>
              <p style="font-size:1.5rem; font-weight:700; color:var(--hot);">${product.price.toLocaleString('vi-VN')} VNĐ</p>
              <p><strong>Danh mục:</strong> ${product.category}</p>
              <p><strong>Tình trạng:</strong> ${product.stock > 0 ? `<span style="color:var(--primary-dark)">Còn hàng (${product.stock})</span>` : `<span style="color:var(--hot)">Hết hàng</span>`}</p>
            </div>
          </div>
          <p style="margin-top:15px; border-top:1px solid #eee; padding-top:15px; line-height:1.6;"><strong>Chi tiết:</strong> ${product.details}</p>
          ${isOutOfStock ? 
            `<button class="btn-primary" disabled style="width:100%;margin-top:20px">Hết hàng</button>` :
            `<button class="btn-primary" style="width:100%;margin-top:20px" onclick="app.addToCart(${product.id})">Thêm vào giỏ</button>`
          }
        `;

        els.productModal.style.display = 'flex';
      };

      // 5. Cart Functions
      const addToCart = (id) => {
        const product = productsData.find(p => p.id === id);
        if (!product || product.stock <= 0) {
          return showToast(`Sản phẩm ${product.name} đã hết hàng!`);
        }

        const cartItem = cart.find(item => item.id === id);
        if (cartItem) {
          if (cartItem.quantity < product.stock) {
            cartItem.quantity++;
            showToast(`Đã thêm 1 x ${product.name}`);
          } else {
            return showToast(`Đã đạt số lượng tối đa (${product.stock}) cho sản phẩm này.`);
          }
        } else {
          cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            quantity: 1,
            img: product.img,
            stock: product.stock
          });
          showToast(`Đã thêm ${product.name} vào giỏ hàng!`);
        }
        save('gf_cart', cart);
        updateCartUI();
        closeModal('product'); // Đóng modal sản phẩm nếu đang mở
      };

      const updateQty = (id, change) => {
        const item = cart.find(i => i.id === id);
        if (!item) return;

        const product = productsData.find(p => p.id === id);

        item.quantity += change;

        if (item.quantity <= 0) {
          removeFromCart(id);
        } else if (item.quantity > product.stock) {
          item.quantity = product.stock;
          showToast(`Không thể thêm, số lượng tối đa là ${product.stock}`);
        }

        save('gf_cart', cart);
        toggleCart(); // Tải lại modal giỏ hàng
      };

      const removeFromCart = (id) => {
        cart = cart.filter(item => item.id !== id);
        showToast('Đã xóa sản phẩm khỏi giỏ hàng.');
        save('gf_cart', cart);
        updateCartUI();
        toggleCart();
      };

      const calculateTotal = () => cart.reduce((total, item) => total + (item.price * item.quantity), 0);

      const renderCart = () => {
        const total = calculateTotal();
        
        let html = `
          <span class="close-modal" onclick="app.closeModal('cart')">&times;</span>
          <h2 style="color:var(--primary-dark); margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">Giỏ Hàng (${cart.length} mục)</h2>
          
          <div style="margin-bottom:15px; border:1px solid #ddd; padding:15px; border-radius:10px; background:var(--bg)">
            <h4>Thông tin giao hàng:</h4>
            <input id="checkoutName" placeholder="Tên người nhận" style="width:100%;padding:10px;margin-bottom:8px;border-radius:8px;border:1px solid #ddd" value="${currentUser ? users[currentUser].name : ''}">
            <input id="checkoutAddress" placeholder="Địa chỉ chi tiết" style="width:100%;padding:10px;margin-bottom:8px;border-radius:8px;border:1px solid #ddd">
            <input id="checkoutPhone" placeholder="Số điện thoại" style="width:100%;padding:10px;margin-bottom:8px;border-radius:8px;border:1px solid #ddd">
          </div>
        `;

        if (!cart.length) {
          html += '<p style="text-align:center;margin-top:20px">Giỏ hàng trống. Hãy chọn sản phẩm!</p>';
        } else {
          html += '<div style="max-height: 250px; overflow-y: auto;">' + cart.map(i => `
            <div class="cart-item">
              <img src="${i.img}" alt="${i.name}">
              <div class="cart-item-details">
                <strong>${i.name}</strong>
                <small>${i.price.toLocaleString('vi-VN')} VNĐ</small>
              </div>
              <div class="qty-control">
                <button onclick="app.updateQty(${i.id},-1)">-</button>
                <span>${i.quantity}</span>
                <button onclick="app.updateQty(${i.id},1)">+</button>
              </div>
              <div style="font-weight:600; font-size:1.05rem; text-align:right;">
                ${(i.price * i.quantity).toLocaleString('vi-VN')} VNĐ
                <button onclick="app.removeFromCart(${i.id})" class="cart-remove-btn"><i class="fas fa-trash"></i></button>
              </div>
            </div>
          `).join('') + '</div>';

          html += `<div class="cart-total">Tổng cộng: ${total.toLocaleString('vi-VN')} VNĐ</div>`;
          html += `<button class="btn-primary" style="width:100%; margin-top:20px;" onclick="app.checkout()">Thanh toán & Xuất hóa đơn PDF</button>`;
        }
        
        els.cartModalContent.innerHTML = html;
      };

      const toggleCart = () => {
        renderCart();
        els.cartModal.style.display = els.cartModal.style.display === 'flex' ? 'none' : 'flex';
      };

      const checkout = () => {
        if (!cart.length) return showToast('Giỏ hàng trống!');
        
        const name = document.getElementById('checkoutName').value.trim();
        const address = document.getElementById('checkoutAddress').value.trim();
        const phone = document.getElementById('checkoutPhone').value.trim();

        if (!name || !address || !phone) {
            return showToast('Vui lòng nhập đầy đủ Tên, Địa chỉ và Số điện thoại!');
        }

        const order = {
            id: Date.now(),
            name,
            address,
            phone,
            total: calculateTotal(),
            items: cart.map(i => ({ name: i.name, quantity: i.quantity, price: i.price })),
            date: new Date().toLocaleDateString('vi-VN')
        };

        // Giảm số lượng tồn kho
        cart.forEach(item => {
            const product = productsData.find(p => p.id === item.id);
            if (product) {
                product.stock -= item.quantity;
            }
        });

        // Tạo hóa đơn PDF
        generatePDFInvoice(order);

        // Reset giỏ hàng
        cart = [];
        save('gf_cart', cart);
        saveProducts();
        updateCartUI();
        renderProducts(productsData);
        closeModal('cart');
        showToast('Thanh toán thành công! Đang tải hóa đơn PDF...');
      };
      
      const closeModal = (type) => {
        if (type === 'cart') els.cartModal.style.display = 'none';
        if (type === 'product') els.productModal.style.display = 'none';
        if (type === 'auth') els.authModal.style.display = 'none';
      };
      
      // 6. PDF Generation (using jsPDF)
      const generatePDFInvoice = (order) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 10;
        
        // Cần tải font tiếng Việt nếu dùng chữ có dấu
        // Tạm thời dùng font mặc định không hỗ trợ tiếng Việt có dấu, có thể bị lỗi font

        doc.setFontSize(22);
        doc.text('HOÁ ĐƠN THANH TOÁN GREENFIT', 105, y, null, null, 'center');
        y += 10;
        
        doc.setFontSize(10);
        doc.text('GreenFit 6.0 | Hotline: 1900 6789 | Email: support@greenfit.vn', 105, y, null, null, 'center');
        y += 10;
        doc.line(14, y, 196, y); // Kẻ ngang
        y += 6;

        doc.setFontSize(12);
        doc.text(`Mã Đơn Hàng: GF-${order.id}`, 14, y);
        doc.text(`Ngày: ${order.date}`, 140, y);
        y += 6;
        doc.text(`Khách Hàng: ${order.name}`, 14, y);
        y += 6;
        doc.text(`Địa Chỉ: ${order.address}`, 14, y);
        y += 6;
        doc.text(`SĐT: ${order.phone}`, 14, y);
        y += 6;

        doc.setFontSize(12);
        doc.text('Chi tiết đơn hàng:', 14, y + 6);
        y += 14; 

        // Tiêu đề bảng
        doc.setFontSize(11);
        doc.text('Tên sản phẩm', 14, y);
        doc.text('SL', 120, y);
        doc.text('Đơn giá (VNĐ)', 140, y);
        doc.text('Thành tiền (VNĐ)', 175, y);
        y += 4;
        doc.line(14, y, 196, y); // Kẻ ngang
        y += 6;

        // Chi tiết sản phẩm
        order.items.forEach(it => {
            doc.text(it.name, 14, y);
            doc.text(it.quantity.toString(), 120, y);
            doc.text(it.price.toLocaleString('vi-VN'), 140, y);
            doc.text((it.price*it.quantity).toLocaleString('vi-VN'), 175, y);
            y += 8;
        });

        doc.line(14, y, 196, y); // Kẻ ngang
        y += 4;

        doc.setFontSize(14);
        doc.text(`TỔNG CỘNG: ${order.total.toLocaleString('vi-VN')} VNĐ`, 14, y + 10);
        
        doc.save(`GreenFit_Invoice_${Date.now()}.pdf`);
      };


      // 7. BMI Functions
      const getBMIStatus = (bmi) => {
        let status = '';
        let color = '';
        let advice = '';
        let suggestions = [];

        if (bmi < 18.5) {
          status = 'Thiếu cân';
          color = '#3498DB'; // Blue
          advice = 'Tăng cường dinh dưỡng và tập luyện nhẹ nhàng để tăng cơ.';
          suggestions = [3, 5, 6]; // Ngũ cốc, Whey Protein, Hạt Chia
        } else if (bmi >= 18.5 && bmi < 24.9) {
          status = 'Cân nặng khỏe mạnh';
          color = '#2ECC71'; // Green
          advice = 'Duy trì chế độ ăn uống cân bằng và tập luyện đều đặn.';
          suggestions = [1, 7, 8]; // Detox, Bình nước, Táo
        } else if (bmi >= 25 && bmi < 29.9) {
          status = 'Thừa cân';
          color = '#F39C12'; // Orange
          advice = 'Giảm khẩu phần ăn có đường, tăng cường rau xanh và tập luyện cường độ trung bình.';
          suggestions = [1, 2, 4]; // Detox, Gạo Lứt, Thảm Yoga
        } else {
          status = 'Béo phì';
          color = '#E74C3C'; // Red
          advice = 'Tham khảo ý kiến bác sĩ, cắt giảm calo mạnh và tăng cường tập luyện.';
          suggestions = [1, 2, 4]; // Detox, Gạo Lứt, Thảm Yoga
        }
        return { bmi, status, color, advice, suggestions };
      };
      
      const calculateBMI = (force = false) => {
        const height = els.heightInput.value / 100; // convert cm to m
        const weight = els.weightInput.value;

        if (!height || !weight) {
          els.bmiResult.style.display = 'none';
          els.recommendations.style.display = 'none';
          return;
        }

        const bmi = (weight / (height * height)).toFixed(2);
        const { status, color, advice, suggestions } = getBMIStatus(parseFloat(bmi));
        const result = els.bmiResult;
        const rec = els.recommendations;

        result.style.display = 'block';
        result.style.backgroundColor = color;
        result.innerHTML = `<strong>BMI: ${bmi}</strong> — ${status}<br><small>${advice}</small>`;
        result.style.animation = 'slideDown 0.5s';

        // CẢI TIẾN: Hiển thị gợi ý sản phẩm dưới dạng mini-card
        rec.innerHTML = '<strong>Gợi ý Sản phẩm:</strong> <div style="display:flex; gap:1rem; flex-wrap:wrap; justify-content:center; margin-top:10px">';
        rec.innerHTML += suggestions.map(id => {
            const p = productsData.find(x => x.id === id);
            if (!p) return '';
            
            return `
              <div class="rec-card" onclick="app.showProduct(${p.id})">
                <img src="${p.img}" alt="${p.name}" loading="lazy" style="width:80px; height:80px; object-fit:cover; border-radius:8px; margin-bottom:5px;">
                <small style="font-weight:600">${p.name.split(' ').slice(0,3).join(' ')}...</small>
                <button class="btn-primary" style="padding:5px 10px; font-size:0.8rem; margin-top:5px;" onclick="event.stopPropagation(); app.addToCart(${p.id})">Thêm</button>
              </div>`;
        }).join('');
        rec.innerHTML += '</div>';
        rec.style.display = 'block';

        if (currentUser && force) {
            const now = new Date();
            // Lưu height và weight dưới dạng số thực
            users[currentUser].bmi.push({bmi, weight: +els.weightInput.value, height: +els.heightInput.value, date: now.toISOString()});
            save('gf_users', users);
            showBMIHistory();
        }
      };
      
      const autoCalcBMI = () => calculateBMI(false);

      const showBMIHistory = () => {
        const historyDiv = document.getElementById('bmiHistory');
        const listDiv = document.getElementById('bmiHistoryList');

        if (currentUser && users[currentUser] && users[currentUser].bmi.length > 0) {
            historyDiv.style.display = 'block';
            listDiv.innerHTML = users[currentUser].bmi
                .slice(-5) // Lấy 5 mục gần nhất
                .reverse() // Mới nhất lên đầu
                .map(item => {
                    const date = new Date(item.date).toLocaleDateString('vi-VN');
                    const time = new Date(item.date).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                    const { status, color } = getBMIStatus(parseFloat(item.bmi));
                    return `
                        <div class="bmi-item">
                            <span style="font-weight:600; color:${color}">BMI ${item.bmi}</span> 
                            (${item.height}cm / ${item.weight}kg) - ${status}
                            <small style="float:right; color:var(--gray);">${date} ${time}</small>
                        </div>
                    `;
                }).join('');
        } else {
            historyDiv.style.display = 'none';
        }
      };

      // 8. Filter Functions
      const filterByCategory = (category) => {
        currentCategory = category;
        // Cập nhật trạng thái nút
        const categoryMap = { 
          'Tất cả': 'All', 
          'Thực phẩm': 'Food', 
          'Đồ uống': 'Drink', 
          'Dụng cụ': 'Gear' 
        };
        document.querySelectorAll('.filter-buttons button').forEach(btn => {
          const btnText = btn.textContent.trim();
          if (categoryMap[btnText] === category || (category === 'All' && btnText === 'Tất cả')) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
        applyFilters();
      };
      
      // CẬP NHẬT: Lọc sản phẩm
      const applyFilters = () => {
        const query = els.searchInput.value.toLowerCase().trim();
        const price = els.priceFilter.value;
        const rating = els.ratingFilter.value;
        const activeCategory = document.querySelector('.filter-buttons button.active')?.textContent.trim(); 
        
        // Lấy category từ tên nút (có thể cần cải thiện nếu tên nút không khớp với data.category)
        const categoryMap = { 
          'Tất cả': 'All', 
          'Thực phẩm': 'Food', 
          'Đồ uống': 'Drink', 
          'Dụng cụ': 'Gear' 
        };
        const category = categoryMap[activeCategory] || 'All';
        
        const filtered = productsData.filter(p => {
          // Lọc theo tìm kiếm
          const matchQuery = p.name.toLowerCase().includes(query);

          // Lọc theo danh mục
          const matchCategory = category === 'All' || p.category === category;

          // Lọc theo giá
          const matchPrice = (() => {
            switch (price) {
              case 'Low': return p.price < 100000;
              case 'Medium': return p.price >= 100000 && p.price <= 500000;
              case 'High': return p.price > 500000;
              case 'All': default: return true;
            }
          })();

          // Lọc theo rating
          const matchRating = (() => {
            if (rating === '4+') return p.rating >= 4;
            if (rating === '3+') return p.rating >= 3;
            return true;
          })();

          return matchQuery && matchCategory && matchPrice && matchRating;
        });

        renderProducts(filtered);
        scrollToProduct();
      };

      const delayedFilter = () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 300);
      };

      const clearFilters = () => {
        els.searchInput.value = '';
        els.priceFilter.value = 'All';
        els.ratingFilter.value = 'All';
        filterByCategory('All'); // Đặt lại bộ lọc danh mục về 'Tất cả'
      };
      
      const scrollToProduct = () => {
        const productsSection = document.getElementById('products');
        if (productsSection) {
            productsSection.scrollIntoView({ behavior: 'smooth' });
        }
      };

      // 9. Chatbot Functions
      const toggleChat = () => {
        els.chatWindow.style.display = els.chatWindow.style.display === 'flex' ? 'none' : 'flex';
        if (els.chatWindow.style.display === 'flex') {
            els.chatInput.focus();
        }
      };

      const appendMessage = (message, sender) => {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${sender}-message`;
        msgDiv.innerHTML = message;
        els.chatBody.appendChild(msgDiv);
        els.chatBody.scrollTop = els.chatBody.scrollHeight;
      };

      const sendMessage = () => {
        const message = els.chatInput.value.trim();
        if (message === '') return;

        appendMessage(message, 'user');
        els.chatInput.value = '';

        // Tự động phản hồi (phản hồi đơn giản)
        setTimeout(() => {
          const response = getBotResponse(message);
          appendMessage(`<strong>AI:</strong> ${response}`, 'bot');
        }, 500);
      };

      const getBotResponse = (msg) => {
        const lowerMsg = msg.toLowerCase();
        
        if (lowerMsg.includes('bmi')) {
            return 'Bạn có thể tính chỉ số BMI của mình tại mục "Tính chỉ số BMI" phía trên. Hãy nhập Chiều cao (cm) và Cân nặng (kg) của bạn.';
        } 
        if (lowerMsg.includes('detox')) {
            return 'Nước Detox Cải Bó Xôi của chúng tôi rất được ưa chuộng. Bạn có muốn thêm vào giỏ hàng ngay không? (Mã SP: 1)';
        } 
        if (lowerMsg.includes('giá')) {
            return 'Giá sản phẩm dao động từ 45k đến 750k VNĐ. Bạn có thể dùng bộ lọc giá trong mục "Sản phẩm" để tìm kiếm dễ dàng hơn.';
        } 
        if (lowerMsg.includes('tên')) {
            return `Tôi là GreenFit AI, trợ lý ảo về sức khỏe và lối sống xanh của bạn.`;
        } 
        if (lowerMsg.includes('chào') || lowerMsg.includes('hello')) {
            return 'Chào bạn, tôi là GreenFit AI. Tôi có thể giúp gì cho bạn về dinh dưỡng, tập luyện hay sản phẩm?';
        }
        if (lowerMsg.includes('đăng ký')) {
            return 'Bạn có thể đăng ký nhận bản tin ở cuối trang web để nhận ưu đãi và kiến thức mới nhất.';
        }
        
        return 'Xin lỗi, tôi chưa hiểu yêu cầu của bạn. Vui lòng hỏi lại về BMI, sản phẩm, hoặc thông tin chung.';
      };

      // 10. UI/Utility Functions
      
      // HÀM NÂNG CẤP: Xử lý cuộn trang để cập nhật thanh tiến trình và nút cuộn lên đầu
      const scrollHandler = () => {
        scrollIndicator();
        handleScrollToTopButton();
      };
      
      const scrollIndicator = () => {
        const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        document.getElementById('scrollIndicator').style.width = scrolled + "%";
      };

      // HÀM NÂNG CẤP: Xử lý hiển thị nút Scroll to Top
      const handleScrollToTopButton = () => {
        if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
          els.scrollToTopBtn.style.display = 'block';
        } else {
          els.scrollToTopBtn.style.display = 'none';
        }
      };

      // HÀM NÂNG CẤP: Cuộn lên đầu trang
      const scrollToTop = () => {
        document.body.scrollTop = 0; // For Safari
        document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
      };

      const toggleMobileMenu = () => {
        document.getElementById('mobileMenu').classList.toggle('active');
      };

      const toggleTheme = () => {
        const html = document.documentElement;
        const currentTheme = html.dataset.theme;
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.dataset.theme = newTheme;
        localStorage.setItem('gf_theme', newTheme);
        // Cập nhật icon
        els.themeToggleBtn.querySelector('i').className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      };

      // HÀM NÂNG CẤP: Xử lý Đăng ký Newsletter
      const subscribeNewsletter = () => {
        const emailInput = document.getElementById('newsletterEmail');
        const email = emailInput.value.trim();
        
        if (!email || !email.includes('@')) {
            return showToast('Vui lòng nhập email hợp lệ!');
        }

        emailInput.value = '';
        showToast(`Cảm ơn bạn! ${email} đã đăng ký nhận bản tin thành công.`);
      };
      
      // 11. Auth Functions
      const handleAuthClick = () => {
        if (currentUser) {
            logout();
        } else {
            showLogin();
        }
      };
      
      const showLogin = () => {
          els.authModalContent.innerHTML = `
              <span class="close-modal" onclick="app.closeModal('auth')">&times;</span>
              <h2 style="color:var(--primary-dark); margin-bottom:20px;">Đăng Nhập</h2>
              <div style="padding: 0 10px;">
                  <input type="email" id="loginEmail" placeholder="Email" style="width:100%;padding:10px;margin-bottom:8px;border-radius:5px;border:1px solid #ddd;">
                  <input type="password" id="loginPass" placeholder="Mật khẩu" style="width:100%;padding:10px;margin-bottom:20px;border-radius:5px;border:1px solid #ddd;">
                  <button class="btn-primary" style="width:100%;" onclick="app.login()">Đăng nhập</button>
                  <p style="text-align:center;margin-top:15px;">Chưa có tài khoản? <a href="#" onclick="event.preventDefault(); app.showRegister()" style="color:var(--primary);font-weight:600;">Đăng ký</a></p>
              </div>
          `;
          els.authModal.style.display = 'flex';
      };
      
      const showRegister = () => {
          els.authModalContent.innerHTML = `
              <span class="close-modal" onclick="app.closeModal('auth')">&times;</span>
              <h2 style="color:var(--primary-dark); margin-bottom:20px;">Đăng Ký Tài Khoản</h2>
              <div style="padding: 0 10px;">
                  <input type="text" id="regName" placeholder="Họ và Tên" style="width:100%;padding:10px;margin-bottom:8px;border-radius:5px;border:1px solid #ddd;">
                  <input type="email" id="regEmail" placeholder="Email" style="width:100%;padding:10px;margin-bottom:8px;border-radius:5px;border:1px solid #ddd;">
                  <input type="password" id="regPass" placeholder="Mật khẩu" style="width:100%;padding:10px;margin-bottom:20px;border-radius:5px;border:1px solid #ddd;">
                  <button class="btn-primary" style="width:100%;" onclick="app.register()">Đăng ký</button>
                  <p style="text-align:center;margin-top:15px;">Đã có tài khoản? <a href="#" onclick="event.preventDefault(); app.showLogin()" style="color:var(--primary);font-weight:600;">Đăng nhập</a></p>
              </div>
          `;
          els.authModal.style.display = 'flex';
      };
      
      // CẬP NHẬT: login/register
      const login = () => {
          const email = document.getElementById('loginEmail').value.trim();
          const pass = document.getElementById('loginPass').value;

          if (users[email] && users[email].pass === pass) {
              currentUser = email;
              localStorage.setItem('gf_user', email);
              showToast(`Chào mừng, ${users[email].name.split(' ')[0]}!`);
              closeModal('auth');
              showBMIHistory();
              updateAuthUI(); // GỌI HÀM CẬP NHẬT UI
          } else showToast('Sai email hoặc mật khẩu!');
      };

      const register = () => {
          const name = document.getElementById('regName').value.trim();
          const email = document.getElementById('regEmail').value.trim();
          const pass = document.getElementById('regPass').value;

          if (!name || !email || !pass) return showToast('Vui lòng điền đầy đủ thông tin!');
          if (users[email]) return showToast('Email này đã được đăng ký!');

          users[email] = { name, pass, bmi: [] };
          save('gf_users', users);
          showToast('Đăng ký thành công! Vui lòng đăng nhập.');
          showLogin();
      };
      
      const logout = () => {
          currentUser = null;
          localStorage.removeItem('gf_user');
          showToast('Đã đăng xuất.');
          showBMIHistory(); // Ẩn lịch sử BMI
          updateAuthUI(); // Cập nhật nút đăng nhập
      };

      // 12. Initialization
      document.addEventListener('DOMContentLoaded', () => {
          // Khởi tạo Theme
          const theme = localStorage.getItem('gf_theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
          document.documentElement.dataset.theme = theme;
          els.themeToggleBtn.querySelector('i').className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
          
          updateCartUI();
          renderProducts(productsData);
          // registerSW(); // Tạm thời bỏ qua PWA Service Worker
          showBMIHistory();
          updateAuthUI(); // KHỞI TẠO NÚT ĐĂNG NHẬP/TÊN NGƯỜI DÙNG

          // Gán listeners
          els.heightInput.addEventListener('input', autoCalcBMI);
          els.weightInput.addEventListener('input', autoCalcBMI);
          els.searchInput.addEventListener('input', delayedFilter);
          els.priceFilter.addEventListener('change', applyFilters);
          els.ratingFilter.addEventListener('change', applyFilters);
      });

      // 13. Public API
      return {
          addToCart, updateQty, removeFromCart, toggleCart, checkout, showProduct, closeModal,
          filterByCategory, applyFilters, delayedFilter, clearFilters,
          calculateBMI, showBMIHistory, scrollToProduct,
          toggleChat, sendMessage, toggleTheme, toggleMobileMenu, 
          scrollHandler, scrollToTop, // CẬP NHẬT: Đổi tên và thêm scrollToTop
          showLogin, showRegister, login, register, handleAuthClick, logout,
          subscribeNewsletter // THÊM:
      };
    })();

    // Gán API vào window để có thể gọi từ HTML (on... attributes)
    window.app = app;
  </script>
</body>
</html>