<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover">
  <meta name="description" content="GreenFit 6.0 - Sống khỏe hữu cơ, tính BMI tự động, giỏ hàng, hóa đơn PDF, dark mode, PWA">
  <meta name="theme-color" content="#548C2F">
  <title>GreenFit 6.0 - Sống Xanh, Tập Mạnh (Upgraded)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <link rel="manifest" href="data:application/manifest+json,{
    \"name\":\"GreenFit 6.0\",
    \"short_name\":\"GreenFit\",
    \"start_url\":\".\",
    \"display\":\"standalone\",
    \"background_color\":\"#FCF8F2\",
    \"theme_color\":\"#548C2F\",
    \"icons\":[{\"src\":\"https://via.placeholder.com/192\",\"sizes\":\"192x192\",\"type\":\"image/png\"},{\"src\":\"https://via.placeholder.com/512\",\"sizes\":\"512x512\",\"type\":\"image/png\"}]
  }">

  <style>
    :root {
      --primary: #548C2F;
      --primary-dark: #3F6F23;
      --secondary: #E3F2FD;
      --hot: #E74C3C;
      --text: #333333;
      --bg: #FCF8F2;
      --card-bg: #FFFFFF;
      --glass: rgba(255, 255, 255, 0.7);
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      --gray: #6B7280;
      --transition: all 0.3s ease-in-out;
    }

    [data-theme="dark"] {
      --text: #F3F4F6;
      --bg: #1F2937;
      --card-bg: #374151;
      --glass: rgba(55, 65, 81, 0.7);
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      --gray: #9CA3AF;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Inter', sans-serif; 
      background-color: var(--bg); 
      color: var(--text); 
      transition: var(--transition);
      scroll-behavior: smooth;
    }
    
    /* Utility */
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    .section-title { 
      text-align: center; 
      margin-bottom: 40px; 
      font-size: 2.5rem; 
      color: var(--primary-dark); 
      font-weight: 800;
      padding-top: 20px;
    }
    
    /* Header & Nav */
    header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background-color: var(--glass);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      padding: 10px 0;
      transition: var(--transition);
    }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 1.8rem;
      font-weight: 900;
      color: var(--primary);
      text-decoration: none;
    }
    .nav-links {
      display: flex;
      gap: 20px;
    }
    .nav-links a {
      color: var(--text);
      text-decoration: none;
      font-weight: 600;
      padding: 5px 10px;
      border-radius: 6px;
      transition: var(--transition);
    }
    .nav-links a:hover {
      color: var(--primary);
    }
    .cart-toggle-group {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .cart-icon {
      position: relative;
      font-size: 1.5rem;
      color: var(--primary);
      cursor: pointer;
    }
    .cart-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: var(--hot);
      color: white;
      font-size: 0.7rem;
      border-radius: 50%;
      padding: 2px 6px;
      font-weight: 700;
    }
    
    /* Mobile Menu */
    .menu-toggle { display: none; font-size: 1.5rem; cursor: pointer; color: var(--text); }
    @media (max-width: 768px) {
      .nav-links {
        display: none;
        flex-direction: column;
        position: absolute;
        top: 60px;
        left: 0;
        width: 100%;
        background-color: var(--card-bg);
        box-shadow: var(--shadow);
        padding: 15px 20px;
        z-index: 999;
      }
      .nav-links.active { display: flex; }
      .nav-links a { width: 100%; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.1); }
      .menu-toggle { display: block; }
    }
    
    /* Scroll Indicator */
    #scrollIndicator {
      position: fixed;
      top: 0;
      left: 0;
      height: 4px;
      background-color: var(--primary);
      z-index: 1001;
      width: 0%;
    }
    
    /* Hero Section */
    .hero {
      background: linear-gradient(rgba(252, 248, 242, 0.7), rgba(252, 248, 242, 0.7)), url('https://via.placeholder.com/1200x500?text=GreenFit+Banner') no-repeat center center/cover;
      height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--text);
    }
    .hero-content h1 { font-size: 3rem; margin-bottom: 10px; color: var(--primary-dark); }
    .hero-content p { font-size: 1.2rem; margin-bottom: 30px; }
    .btn-primary {
      background-color: var(--primary);
      color: white;
      padding: 12px 25px;
      border-radius: 50px;
      text-decoration: none;
      font-weight: 600;
      transition: var(--transition);
      border: none;
      cursor: pointer;
    }
    .btn-primary:hover { background-color: var(--primary-dark); }
    
    /* BMI Calculator */
    #bmi {
      background-color: var(--secondary);
      padding: 50px 0;
      text-align: center;
    }
    .bmi-calc {
      background-color: var(--card-bg);
      padding: 40px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      max-width: 600px;
      margin: 0 auto;
    }
    .input-group {
      position: relative;
      margin-bottom: 25px;
    }
    .input-group input {
      width: 100%;
      padding: 14px 14px 14px 45px; /* Tăng padding trái */
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: var(--bg);
      color: var(--text);
      font-size: 1rem;
      transition: var(--transition);
    }
    .input-group label {
      position: absolute;
      top: 14px;
      left: 40px; /* Điều chỉnh vị trí */
      color: var(--gray);
      transition: var(--transition);
      pointer-events: none;
      background: var(--bg);
      padding: 0 5px;
    }
    .input-group input:focus + label,
    .input-group input:not(:placeholder-shown) + label {
      top: -10px;
      left: 35px;
      font-size: 0.75rem;
      color: var(--primary);
    }
    .input-group i {
      position: absolute;
      top: 16px;
      left: 14px; /* Đặt icon bên trái */
      color: var(--gray);
      transition: var(--transition);
    }
    .input-group input:focus ~ i { color: var(--primary); }
    .input-group input:focus { border-color: var(--primary); }
    
    #bmiResult {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      color: white;
      font-weight: 700;
      display: none;
      animation: slideDown 0.5s;
    }
    #bmiResult small { 
      display: block; 
      margin-top: 6px; 
      font-size: 0.95rem; 
      line-height: 1.5; 
    }
    #bmiHistory {
      margin-top: 20px;
      border-top: 1px solid #ddd;
      padding-top: 15px;
      text-align: left;
      display: none;
    }
    .bmi-item {
      padding: 8px 0;
      border-bottom: 1px dashed #eee;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Products Section */
    #products { padding: 50px 0; }
    .search-filters {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      align-items: center;
      flex-wrap: wrap;
      background: var(--card-bg);
      padding: 20px;
      border-radius: 15px;
      box-shadow: var(--shadow);
    }
    .filter-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .filter-buttons button {
      background-color: var(--secondary);
      color: var(--text);
      padding: 8px 15px;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
    }
    .filter-buttons button.active, .filter-buttons button:hover {
      background-color: var(--primary);
      color: white;
    }
    .search-filters input, .search-filters select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: var(--bg);
      color: var(--text);
      transition: var(--transition);
    }
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 30px;
    }
    .product-card {
      background-color: var(--card-bg);
      border-radius: 15px;
      box-shadow: var(--shadow);
      overflow: hidden;
      text-align: center;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .product-card:hover {
      transform: translateY(-5px); /* Giảm độ chuyển động */
      box-shadow: 0 18px 40px rgba(0,0,0,0.12);
    }
    .product-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    .product-info {
      padding: 15px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    .product-info h3 {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: var(--primary-dark);
    }
    .price {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--hot);
      margin-bottom: 10px;
    }
    .rating {
      color: #FFD700;
      margin-bottom: 10px;
    }
    .btn-add-cart {
      background-color: var(--primary);
      color: white;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      margin-top: auto;
    }
    .btn-add-cart:hover {
      background-color: var(--primary-dark);
    }
    .btn-add-cart[disabled] { 
        background: var(--gray) !important; 
        cursor: not-allowed; 
        opacity: 0.8;
    }
    #noResults {
      text-align: center;
      grid-column: 1 / -1;
      padding: 30px;
      color: var(--gray);
      font-size: 1.2rem;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: var(--card-bg);
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      position: relative;
      box-shadow: var(--shadow);
    }
    .close-modal {
      color: var(--gray);
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .cart-total {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid var(--primary);
        font-size: 1.3rem;
        font-weight: 700;
        text-align: right;
        color: var(--primary-dark);
    }
    
    /* Blog/Footer */
    #blog, footer { padding: 50px 0; }
    #blog { background-color: var(--secondary); }
    .blog-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
    }
    .blog-post {
      background-color: var(--card-bg);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }
    .blog-post:hover { transform: translateY(-5px); }
    .blog-post img { width: 100%; height: 200px; object-fit: cover; }
    .post-content { padding: 15px; }
    .post-content h4 { color: var(--primary-dark); margin-bottom: 10px; }
    .post-content p { font-size: 0.9rem; color: var(--gray); }

    footer {
      background-color: var(--primary-dark);
      color: white;
      text-align: center;
    }
    .footer-content {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .footer-section {
      width: 30%;
      min-width: 250px;
      margin-bottom: 20px;
      text-align: left;
    }
    .footer-section h4 { border-bottom: 2px solid white; padding-bottom: 10px; margin-bottom: 10px; }
    .social-links a { 
      color: white; 
      font-size: 1.5rem; 
      margin-right: 15px; 
      transition: var(--transition);
    }
    .social-links a:hover { color: var(--secondary); }
    
    /* Chatbot */
    #chatbot {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    #chat-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 1.8rem;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    #chat-window {
      background-color: var(--card-bg);
      border-radius: 15px;
      box-shadow: var(--shadow);
      width: 300px;
      height: 400px;
      position: absolute;
      bottom: 70px;
      right: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--primary);
      display: none;
    }
    #chat-header {
      background-color: var(--primary);
      color: white;
      padding: 10px;
      font-weight: 600;
    }
    #chat-body {
      flex-grow: 1;
      padding: 10px;
      overflow-y: auto;
      background-color: var(--bg);
    }
    .message {
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 10px;
      max-width: 85%;
      word-wrap: break-word;
    }
    .user-message {
      background-color: var(--primary);
      color: white;
      margin-left: auto;
    }
    .bot-message {
      background-color: var(--secondary);
      color: var(--text);
      margin-right: auto;
    }
    #chat-input-area {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
    }
    #chat-input {
      flex-grow: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-right: 5px;
      background-color: var(--bg);
      color: var(--text);
    }
    #chat-send-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }

    /* --- STYLES NÂNG CẤP --- */

    /* 1. PRODUCT CARD IMPROVEMENT */
    .product-card:hover { 
        transform: translateY(-5px); 
        box-shadow: 0 18px 40px rgba(0,0,0,0.12); 
    }
    .btn-add-cart[disabled] { 
        background: var(--gray) !important; 
        cursor: not-allowed; 
        opacity: 0.8;
    }

    /* 2. CART MODAL ENHANCEMENT */
    .cart-item {
        display: grid;
        grid-template-columns: 60px 2fr 1.5fr 70px; /* Thêm cột cho Quantity và Total */
        gap: 12px;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .cart-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
    .cart-item-details { flex-direction: column; align-items: flex-start; }
    .cart-item-details strong { font-size: 1rem; }
    .cart-item-details small { color: var(--gray); font-size: 0.85rem; }
    .qty-control { display: flex; gap: 4px; align-items: center; justify-content: flex-end; }
    .qty-control button { 
        width: 24px; height: 24px; font-size: 1rem; line-height: 1;
        border: 1px solid var(--primary); color: var(--primary);
        background: none; border-radius: 4px; transition: .2s;
        cursor: pointer;
    }
    .qty-control button:hover { background: var(--primary); color: white; }
    .cart-remove-btn { 
        background: var(--hot) !important; color: #fff !important; 
        border: none !important; font-size: 0.9rem !important;
        padding: 6px 8px !important; border-radius: 4px !important;
        cursor: pointer;
    }
    .cart-item > div:last-child {
      display: flex; 
      flex-direction: column; 
      align-items: flex-end; 
      justify-content: center;
    }
    
    /* 3. BMI INPUT/RESULT VISUALS */
    .input-group i { 
        left: 14px; 
        right: auto;
        font-size: 1rem;
    }
    .input-group input { 
        padding: 14px 14px 14px 45px; 
    }
    .input-group label { 
        left: 40px; 
    }

    /* 4. RECOMMENDATION MINI-CARDS */
    #recommendations {
        display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;
        margin-top: 16px; padding: 1.5rem; border-radius: 16px; 
        background: var(--card-bg); box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        display: none; /* Khởi tạo ẩn */
    }
    .rec-card {
        display: flex; flex-direction: column; align-items: center; text-align: center;
        width: 140px; padding: 10px; border-radius: 12px;
        border: 1px solid rgba(84,140,47,.2); background: var(--glass);
        transition: var(--transition);
        cursor: pointer;
    }
    .rec-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .rec-card img { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; margin-bottom: 8px; }
    .rec-card button {
        background: var(--primary-dark); color: white; font-size: 0.75rem;
        padding: 6px 10px; margin-top: 6px; border-radius: 40px; border: none;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .rec-card button:hover { background: var(--primary); }

    /* 5. USER AVATAR / THEME TOGGLE */
    .cart-toggle-group button.theme-toggle {
        background: none; border: none; font-size: 1.5rem; color: var(--text); cursor: pointer;
    }
    .user-info-btn { 
        font-size: 1.5rem; 
        color: var(--primary); 
        background: none; 
        border: none;
        padding: 0;
        cursor: pointer;
    }
    .user-info-btn.logged-in {
        font-size: 1rem;
        padding: 8px 12px;
        border-radius: 50px;
        background: var(--primary);
        color: white;
        font-weight: 700;
    }

    /* 6. CHATBOT TYPING INDICATOR */
    .typing-indicator {
      display: inline-flex;
      gap: 4px;
      align-items: center;
      height: 10px;
      margin-left: 5px;
    }
    .typing-indicator span {
      width: 6px;
      height: 6px;
      background-color: var(--primary);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(2) { animation-delay: -0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: -0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-4px); }
    }
    
    /* Responsive adjustments */
    @media (max-width: 600px) {
      .search-filters {
        flex-direction: column;
        align-items: stretch;
      }
      .filter-buttons {
        justify-content: center;
      }
      .cart-item {
        grid-template-columns: 40px 1.5fr 1fr 50px;
      }
      .cart-item img { width: 40px; height: 40px; }
      .cart-item-details strong { font-size: 0.9rem; }
    }
  </style>
</head>
<body onscroll="app.scrollIndicator()">

  <div id="scrollIndicator"></div>

  <header>
    <div class="container">
      <nav class="navbar">
        <a href="#hero" class="logo">GreenFit 6.0</a>
        
        <div class="menu-toggle" onclick="app.toggleMobileMenu()">
          <i class="fas fa-bars"></i>
        </div>
        
        <div class="nav-links" id="mobileMenu">
          <a href="#products" onclick="app.scrollToProduct()">Sản phẩm</a>
          <a href="#bmi">Tính BMI</a>
          <a href="#blog">Blog</a>
          <a href="#contact">Liên hệ</a>
        </div>
        
        <div class="cart-toggle-group">
          <div class="cart-icon" onclick="app.toggleCart()">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-count" id="cartCount">0</span>
          </div>
          <button class="theme-toggle" onclick="app.toggleTheme()" id="themeToggleBtn">
              <i class="fas fa-moon"></i>
          </button>
          <button id="authBtn" class="user-info-btn" onclick="app.handleAuthClick()">
              <i class="fas fa-user"></i>
          </button>
        </div>
      </nav>
    </div>
  </header>

  <main>
    <section id="hero" class="hero">
      <div class="hero-content">
        <h1>Sống Xanh, Tập Mạnh</h1>
        <p>Thực phẩm hữu cơ & dụng cụ tập luyện cho một lối sống khỏe mạnh.</p>
        <a href="#products" class="btn-primary" onclick="app.scrollToProduct()">Khám phá ngay</a>
      </div>
    </section>

    <section id="bmi">
      <div class="container">
        <h2 class="section-title">Tính chỉ số BMI</h2>
        <div class="bmi-calc">
          <p>Nhập chiều cao và cân nặng để tính BMI của bạn:</p>
          <div class="input-group">
            <input id="height" type="number" min="100" max="250" required placeholder=" ">
            <label for="height">Chiều cao</label>
            <i class="fa-solid fa-ruler"></i>
            <span style="position:absolute; right:14px; top:16px; color:var(--gray)">cm</span>
          </div>
          <div class="input-group">
            <input id="weight" type="number" min="30" max="200" required placeholder=" ">
            <label for="weight">Cân nặng</label>
            <i class="fa-solid fa-weight-scale"></i>
            <span style="position:absolute; right:14px; top:16px; color:var(--gray)">kg</span>
          </div>
          <button class="btn-primary" id="calcBtn" onclick="app.calculateBMI(true)">Tính BMI</button>
          
          <div id="bmiResult"></div>

          <div id="recommendations"></div>
          
          <div id="bmiHistory">
            <h4>Lịch sử BMI (5 mục gần nhất):</h4>
            <div id="bmiHistoryList"></div>
            <small style="color:var(--gray)">Đăng nhập để lưu lịch sử</small>
          </div>
        </div>
      </div>
    </section>

    <section id="products">
      <div class="container">
        <h2 class="section-title">Sản Phẩm Hữu Cơ</h2>
        
        <div class="search-filters">
          <div class="filter-buttons">
            <button onclick="app.filterByCategory('All')" class="active">Tất cả</button>
            <button onclick="app.filterByCategory('Food')">Thực phẩm</button>
            <button onclick="app.filterByCategory('Drink')">Đồ uống</button>
            <button onclick="app.filterByCategory('Gear')">Dụng cụ</button>
          </div>
          <input type="text" id="searchInput" placeholder="Tìm kiếm sản phẩm...">
          <select id="priceFilter" onchange="app.applyFilters()">
            <option value="All">Lọc theo Giá</option>
            <option value="Low">Dưới 100k</option>
            <option value="Medium">100k - 500k</option>
            <option value="High">Trên 500k</option>
          </select>
          <select id="ratingFilter" onchange="app.applyFilters()">
            <option value="All">Lọc theo Đánh giá</option>
            <option value="4+">4 sao trở lên</option>
            <option value="3+">3 sao trở lên</option>
          </select>
          <button class="btn-primary" style="background:var(--gray)" onclick="app.clearFilters()">Xóa lọc</button>
        </div>
        
        <div class="product-grid" id="productGrid">
          <div id="noResults" style="display:none">Không tìm thấy sản phẩm nào phù hợp.</div>
        </div>
      </div>
    </section>

    <section id="blog">
      <div class="container">
        <h2 class="section-title">Kiến Thức Sống Xanh</h2>
        <div class="blog-grid">
          <div class="blog-post">
            <img src="https://via.placeholder.com/300x200?text=Blog+1" alt="Lợi ích của Gạo Lứt">
            <div class="post-content">
              <h4>5 lợi ích không ngờ của Gạo Lứt</h4>
              <p>Gạo lứt không chỉ là thực phẩm giảm cân mà còn mang lại nhiều lợi ích sức khỏe khác...</p>
              <a href="#" style="color:var(--primary);font-weight:600">Đọc thêm &rarr;</a>
            </div>
          </div>
          <div class="blog-post">
            <img src="https://via.placeholder.com/300x200?text=Blog+2" alt="Các bài tập HIIT">
            <div class="post-content">
              <h4>HIIT: Tập luyện cường độ cao trong 15 phút</h4>
              <p>Các bài tập cường độ cao ngắt quãng giúp đốt cháy calo nhanh chóng và hiệu quả...</p>
              <a href="#" style="color:var(--primary);font-weight:600">Đọc thêm &rarr;</a>
            </div>
          </div>
          <div class="blog-post">
            <img src="https://via.placeholder.com/300x200?text=Blog+3" alt="Detox tại nhà">
            <div class="post-content">
              <h4>Công thức nước Detox tại nhà</h4>
              <p>Thanh lọc cơ thể, thải độc và tăng cường năng lượng với các công thức nước ép đơn giản...</p>
              <a href="#" style="color:var(--primary);font-weight:600">Đọc thêm &rarr;</a>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer id="contact">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h4>Về GreenFit</h4>
          <p>Cam kết cung cấp sản phẩm hữu cơ chất lượng cao và đồng hành cùng bạn trên hành trình sống khỏe.</p>
        </div>
        <div class="footer-section">
          <h4>Liên hệ</h4>
          <p>Địa chỉ: 123 Đường Sống Xanh, Q. Khỏe Mạnh, TP. Hà Nội</p>
          <p>Email: contact@greenfit.com</p>
          <p>Hotline: 0987-654-321</p>
        </div>
        <div class="footer-section">
          <h4>Mạng xã hội</h4>
          <div class="social-links">
            <a href="#"><i class="fab fa-facebook-f"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
            <a href="#"><i class="fab fa-youtube"></i></a>
          </div>
        </div>
      </div>
      <p style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">© 2025 GreenFit 6.0. All rights reserved.</p>
    </div>
  </footer>

  <div id="cartModal" class="modal" onclick="if(event.target.id==='cartModal') app.closeModal('cart')">
    <div class="modal-content" id="cartModalContent">
      </div>
  </div>

  <div id="productModal" class="modal" onclick="if(event.target.id==='productModal') app.closeModal('product')">
    <div class="modal-content" id="productModalContent">
      </div>
  </div>

  <div id="authModal" class="modal" onclick="if(event.target.id==='authModal') app.closeModal('auth')">
    <div class="modal-content" id="authModalContent">
      </div>
  </div>

  <div id="chatbot">
    <button id="chat-btn" onclick="app.toggleChat()"><i class="fas fa-robot"></i></button>
    <div id="chat-window">
      <div id="chat-header">GreenFit AI - Hỏi đáp 24/7</div>
      <div id="chat-body">
        <div class="message bot-message"><strong>AI:</strong> Chào bạn, tôi là GreenFit AI. Tôi có thể giúp gì cho bạn về dinh dưỡng, tập luyện hay sản phẩm?</div>
      </div>
      <div id="chat-input-area">
        <input type="text" id="chatInput" placeholder="Nhập tin nhắn..." onkeyup="if(event.keyCode===13) app.sendMessage()">
        <button id="chat-send-btn" onclick="app.sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <script>
    const app = (function() {
      // 1. Dữ liệu khởi tạo
      let productsData = [
        { id: 1, name: 'Detox Juice Cải Bó Xôi', price: 89000, category: 'Drink', rating: 4.8, stock: 50, img: 'https://via.placeholder.com/150/548C2F?text=Detox' },
        { id: 2, name: 'Protein Powder Hữu Cơ', price: 750000, category: 'Food', rating: 4.5, stock: 15, img: 'https://via.placeholder.com/150/3F6F23?text=Protein' },
        { id: 3, name: 'Hạt Chia Tự Nhiên', price: 120000, category: 'Food', rating: 4.9, stock: 100, img: 'https://via.placeholder.com/150/9CBA7E?text=Chia' },
        { id: 4, name: 'Gạo Lứt Giảm Cân', price: 45000, category: 'Food', rating: 4.6, stock: 0, img: 'https://via.placeholder.com/150/7A9A5C?text=Gao+Lut' },
        { id: 5, name: 'Energy Bar Hạt Tổng Hợp', price: 60000, category: 'Food', rating: 4.7, stock: 75, img: 'https://via.placeholder.com/150/B8D89C?text=Bar' },
        { id: 6, name: 'Thảm Yoga Chống Trượt', price: 350000, category: 'Gear', rating: 4.4, stock: 30, img: 'https://via.placeholder.com/150/548C2F?text=Yoga+Mat' },
        { id: 7, name: 'Bình Nước Thủy Tinh', price: 150000, category: 'Drink', rating: 4.3, stock: 60, img: 'https://via.placeholder.com/150/3F6F23?text=Bottle' },
        { id: 8, name: 'Tạ Tay 2kg', price: 280000, category: 'Gear', rating: 4.7, stock: 20, img: 'https://via.placeholder.com/150/9CBA7E?text=Dumbbell' },
      ];

      let cart = JSON.parse(localStorage.getItem('gf_cart')) || [];
      let users = JSON.parse(localStorage.getItem('gf_users')) || {};
      let currentUser = localStorage.getItem('gf_user') || null;

      // 2. DOM Elements
      const els = {
          cartCount: document.getElementById('cartCount'),
          productGrid: document.getElementById('productGrid'),
          searchInput: document.getElementById('searchInput'),
          priceFilter: document.getElementById('priceFilter'),
          ratingFilter: document.getElementById('ratingFilter'),
          calcBtn: document.getElementById('calcBtn'),
          chatBody: document.getElementById('chat-body'),
          chatInput: document.getElementById('chatInput'),
          noResults: document.getElementById('noResults'),
          // THÊM CÁC ELEMENTS NÂNG CẤP
          heightInput: document.getElementById('height'),
          weightInput: document.getElementById('weight'),
          authBtn: document.getElementById('authBtn'),
          themeToggleBtn: document.getElementById('themeToggleBtn')
      };

      // 3. Utils
      const save = (key, data) => localStorage.setItem(key, JSON.stringify(data));
      const saveProducts = () => save('gf_products', productsData);
      const updateCartUI = () => els.cartCount.textContent = cart.length;

      // CẬP NHẬT UI NÚT ĐĂNG NHẬP
      const updateAuthUI = () => {
          if (currentUser) {
              const user = users[currentUser];
              els.authBtn.classList.add('logged-in');
              els.authBtn.innerHTML = user.name.split(' ')[0];
          } else {
              els.authBtn.classList.remove('logged-in');
              els.authBtn.innerHTML = '<i class="fas fa-user"></i>';
          }
      };

      // 4. Product Functions
      const renderProducts = (products) => {
          els.productGrid.innerHTML = '';
          if (products.length === 0) {
              els.noResults.style.display = 'block';
              return;
          }
          els.noResults.style.display = 'none';

          products.forEach(p => {
              const card = document.createElement('div');
              card.className = 'product-card';
              
              const ratingStars = '⭐'.repeat(Math.round(p.rating));
              const isOutOfStock = p.stock <= 0;
              
              card.innerHTML = `
                  <img src="${p.img}" alt="${p.name}" loading="lazy" onclick="app.showProduct(${p.id})">
                  <div class="product-info">
                      <h3>${p.name}</h3>
                      <div class="rating">${ratingStars} (${p.rating})</div>
                      <div class="price">${p.price.toLocaleString('vi-VN')} VNĐ</div>
                      <small style="color:${isOutOfStock ? 'var(--hot)' : 'var(--primary-dark)'}; font-weight:600;">${isOutOfStock ? 'HẾT HÀNG' : `Tồn kho: ${p.stock}`}</small>
                      <button class="btn-add-cart" onclick="event.stopPropagation(); app.addToCart(${p.id})" ${isOutOfStock ? 'disabled' : ''}>
                          ${isOutOfStock ? 'Hết hàng' : '<i class="fas fa-cart-plus"></i> Thêm vào giỏ'}
                      </button>
                  </div>
              `;
              els.productGrid.appendChild(card);
          });
      };

      const addToCart = (id) => {
          const product = productsData.find(p => p.id === id);
          if (!product || product.stock <= 0) return alert('Sản phẩm đã hết hàng!');
          
          const cartItem = cart.find(item => item.id === id);
          
          if (cartItem) {
              if (cartItem.quantity < product.stock) {
                  cartItem.quantity++;
              } else {
                  return alert(`Không thể thêm, chỉ còn ${product.stock} sản phẩm!`);
              }
          } else {
              cart.push({ id: product.id, name: product.name, price: product.price, img: product.img, quantity: 1 });
          }
          
          save('gf_cart', cart);
          updateCartUI();
          alert(`${product.name} đã được thêm vào giỏ hàng!`);
      };

      const removeFromCart = (id) => {
          cart = cart.filter(item => item.id !== id);
          save('gf_cart', cart);
          updateCartUI();
          toggleCart(); // Tải lại modal giỏ hàng
      };
      
      const updateQty = (id, change) => {
          const item = cart.find(i => i.id === id);
          const product = productsData.find(p => p.id === id);

          if (item) {
              const newQty = item.quantity + change;
              if (newQty > 0 && newQty <= product.stock) {
                  item.quantity = newQty;
              } else if (newQty > product.stock) {
                  alert(`Số lượng tối đa có thể mua là ${product.stock}`);
              } else if (newQty <= 0) {
                  removeFromCart(id);
                  return;
              }
              save('gf_cart', cart);
              toggleCart(); // Tải lại modal giỏ hàng
          }
      };

      // CẬP NHẬT: Lọc sản phẩm
      const applyFilters = () => {
          const query = els.searchInput.value.toLowerCase().trim();
          const price = els.priceFilter.value;
          const rating = els.ratingFilter.value;
          const activeCategory = document.querySelector('.filter-buttons button.active')?.textContent.trim();
          
          const category = activeCategory === 'Tất cả' ? 'All' : productsData.find(p => p.category)?.category;

          const filtered = productsData.filter(p => {
              // Lọc theo tìm kiếm
              const matchQuery = p.name.toLowerCase().includes(query);
              
              // Lọc theo danh mục
              const matchCategory = category === 'All' || p.category === category;
              
              // Lọc theo giá
              const matchPrice = (() => {
                  switch (price) {
                      case 'Low': return p.price < 100000;
                      case 'Medium': return p.price >= 100000 && p.price <= 500000;
                      case 'High': return p.price > 500000;
                      case 'All':
                      default: return true;
                  }
              })();
              
              // Lọc theo rating
              const matchRating = (() => {
                  if (rating === '4+') return p.rating >= 4;
                  if (rating === '3+') return p.rating >= 3;
                  return true;
              })();
              
              return matchQuery && matchCategory && matchPrice && matchRating;
          });
          
          renderProducts(filtered);
      };

      const delayedFilter = () => {
          clearTimeout(window.filterTimeout);
          window.filterTimeout = setTimeout(applyFilters, 300);
      };
      
      const filterByCategory = (category) => {
          document.querySelectorAll('.filter-buttons button').forEach(btn => {
              btn.classList.remove('active');
          });
          const btn = document.querySelector(`.filter-buttons button[onclick="app.filterByCategory('${category}')"]`);
          if (btn) btn.classList.add('active');
          applyFilters();
      };
      
      const clearFilters = () => {
          els.searchInput.value = '';
          els.priceFilter.value = 'All';
          els.ratingFilter.value = 'All';
          filterByCategory('All');
      };

      // 5. Cart/Checkout Functions
      // CẬP NHẬT: Toggle Cart
      const toggleCart = () => {
          const modal = document.getElementById('cartModal');
          const content = document.getElementById('cartModalContent');
          if (modal.style.display === 'flex') { closeModal('cart'); return; }

          const total = cart.reduce((s,i) => s + i.price * i.quantity, 0);

          let html = `<span class="close-modal" onclick="app.closeModal('cart')">&times;</span><h2>Giỏ hàng (${cart.length} món)</h2>`;
          
          const user = currentUser ? users[currentUser] : { name: '', email: '' };

          // THÊM: Input giao hàng
          const checkoutForm = `
              <div style="margin-top:16px;padding:16px;border-top:1px solid #ddd;">
                  <h4 style="margin-bottom:10px">Thông tin giao hàng</h4>
                  <input id="checkoutName" placeholder="Họ tên" value="${user.name}" style="width:100%;padding:10px;margin-bottom:8px;border-radius:8px;border:1px solid #ddd">
                  <input id="checkoutAddress" placeholder="Địa chỉ chi tiết" style="width:100%;padding:10px;margin-bottom:8px;border-radius:8px;border:1px solid #ddd">
                  <input id="checkoutPhone" placeholder="Số điện thoại" style="width:100%;padding:10px;margin-bottom:8px;border-radius:8px;border:1px solid #ddd">
              </div>
          `;

          if (!cart.length) {
              html += '<p style="text-align:center;margin-top:20px">Giỏ hàng trống. Hãy chọn sản phẩm!</p>';
          }
          else {
              html += '<div style="max-height: 250px; overflow-y: auto;">' + cart.map(i => `
                  <div class="cart-item">
                      <img src="${i.img}" alt="${i.name}">
                      <div class="cart-item-details">
                          <strong>${i.name}</strong>
                          <small>${i.price.toLocaleString('vi-VN')} VNĐ</small>
                      </div>
                      <div class="qty-control">
                          <button onclick="app.updateQty(${i.id},-1)">-</button>
                          <span>${i.quantity}</span>
                          <button onclick="app.updateQty(${i.id},1)">+</button>
                      </div>
                      <div style="font-weight:600; font-size:1.05rem; text-align:right;">
                          ${(i.price * i.quantity).toLocaleString('vi-VN')} VNĐ
                          <button onclick="app.removeFromCart(${i.id})" class="cart-remove-btn"><i class="fa-solid fa-times"></i></button>
                      </div>
                  </div>
              `).join('') + '</div>';
              
              html += checkoutForm;
              html += `<div class="cart-total">Tổng thanh toán: ${total.toLocaleString('vi-VN')} VNĐ</div>`;
              html += `<div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap">
                  <button onclick="app.checkout('COD')" style="flex:1;background:var(--primary);color:#fff;padding:12px;border:none;border-radius:8px;font-weight:700">Thanh toán COD</button>
                  <button onclick="app.checkout('MOMO')" style="flex:1;background:#e51e5b;color:#fff;padding:12px;border:none;border-radius:8px;font-weight:700">Momo</button>
              </div>`;
          }
          content.innerHTML = html;
          modal.style.display = 'flex';
      };

      // CẬP NHẬT: Checkout và PDF chi tiết
      const checkout = (method) => {
          if (!cart.length) return;
          
          const name = document.getElementById('checkoutName').value.trim();
          const address = document.getElementById('checkoutAddress').value.trim();
          const phone = document.getElementById('checkoutPhone').value.trim();

          if (!name || !address || !phone) {
              return alert('Vui lòng điền đầy đủ thông tin giao hàng!');
          }

          if (!confirm(`Xác nhận đặt hàng ${cart.length} món với phương thức ${method}?`)) return;

          // Cập nhật tồn kho (local)
          cart.forEach(ci => {
              const p = productsData.find(x => x.id === ci.id);
              if (p) { p.stock -= ci.quantity; if (p.stock < 0) p.stock = 0; }
          });
          saveProducts();
          
          const total = cart.reduce((s,i)=>s+i.price*i.quantity,0);
          const orderInfo = { name, address, phone, items: JSON.parse(JSON.stringify(cart)), total, method, date: new Date().toISOString() };
          
          // Lưu lịch sử đơn hàng cho user (nếu đã đăng nhập)
          if (currentUser) {
              users[currentUser].orders.push(orderInfo);
              save('gf_users', users);
          }
          
          generateInvoicePDF(orderInfo);
          
          cart = []; save('gf_cart', cart); 
          updateCartUI(); 
          renderProducts(productsData); 
          closeModal('cart');
          alert('Thanh toán thành công! Hóa đơn đã tải về.');
      };

      // CẬP NHẬT: generateInvoicePDF
      const generateInvoicePDF = (order) => {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.setFontSize(18); doc.text('HÓA ĐƠN ĐẶT HÀNG - GreenFit', 14, 20);
          doc.setFontSize(11);
          doc.text(`Mã ĐH: #${Date.now().toString().slice(-6)}`, 14, 28);
          doc.text(`Ngày: ${new Date(order.date).toLocaleString('vi-VN')}`, 14, 34);
          doc.text(`Phương thức: ${order.method}`, 14, 40);

          // Thông tin khách hàng
          doc.setFontSize(12); doc.text('Thông tin khách hàng:', 14, 50);
          doc.setFontSize(11);
          doc.text(`- Tên: ${order.name}`, 14, 56);
          doc.text(`- SĐT: ${order.phone}`, 14, 62);
          
          // Tách địa chỉ để hiển thị
          const addressLines = doc.splitTextToSize(`- Địa chỉ: ${order.address}`, 180);
          let y = 68;
          addressLines.forEach(line => {
              doc.text(line, 14, y);
              y += 6;
          });


          doc.setFontSize(12); doc.text('Chi tiết đơn hàng:', 14, y + 6);
          y += 14;

          // Tiêu đề bảng
          doc.setFontSize(11);
          doc.text('Tên sản phẩm', 14, y);
          doc.text('SL', 120, y);
          doc.text('Đơn giá', 140, y);
          doc.text('Thành tiền', 175, y);
          y += 4;
          doc.line(14, y, 196, y); // Kẻ ngang
          y += 6;
          
          // Chi tiết sản phẩm
          order.items.forEach(it => { 
              doc.text(it.name, 14, y); 
              doc.text(it.quantity.toString(), 120, y);
              doc.text(it.price.toLocaleString('vi-VN'), 140, y);
              doc.text((it.price*it.quantity).toLocaleString('vi-VN') + ' VNĐ', 175, y); 
              y += 8; 
          });

          doc.line(14, y, 196, y); // Kẻ ngang
          y += 4;
          doc.setFontSize(14); doc.text(`TỔNG CỘNG: ${order.total.toLocaleString('vi-VN')} VNĐ`, 14, y + 10);
          doc.save(`GreenFit_Invoice_${Date.now()}.pdf`);
      };


      // 6. BMI Functions
      const autoCalcBMI = () => {
          const h = +els.heightInput.value;
          const w = +els.weightInput.value;
          
          // Chỉ tính khi input hợp lệ
          if (h >= 100 && h <= 250 && w >= 30 && w <= 200) {
              calculateBMI(false);
          } else {
              document.getElementById('bmiResult').style.display = 'none';
              document.getElementById('recommendations').style.display = 'none';
          }
      };

      // CẬP NHẬT: calculateBMI (với mini-card)
      const calculateBMI = (force = false) => {
          const h = +els.heightInput.value / 100;
          const w = +els.weightInput.value;
          const result = document.getElementById('bmiResult');
          const rec = document.getElementById('recommendations');
          
          if (h < 1 || w < 1) { // Kiểm tra input cơ bản
              result.style.display = 'none';
              rec.style.display = 'none';
              return;
          }

          const bmi = (w / (h * h)).toFixed(1);
          let color, status, advice, suggestions;

          if (bmi < 18.5) { 
              color = '#f1c40f'; status = 'Gầy'; advice = 'Tăng cân: ưu tiên protein, ăn nhiều bữa, tập tạ. Gợi ý: Protein, Energy Bar.';
              suggestions = [2, 5];
          }
          else if (bmi < 25) { 
              color = '#27ae60'; status = 'Bình thường'; advice = 'Duy trì tốt! Tập đều + ăn đủ chất. Gợi ý: Detox Juice, Hạt Chia.';
              suggestions = [1, 3]; 
          }
          else if (bmi < 30) { 
              color = '#f39c12'; status = 'Thừa cân'; advice = 'Giảm tinh bột, tăng rau, cardio 30p/ngày. Gợi ý: Gạo Lứt, Detox Juice.';
              suggestions = [4, 1, 6]; 
          }
          else { 
              color = '#e74c3c'; status = 'Béo phì'; advice = 'Cần giảm cân gấp: cắt đường, HIIT, tư vấn bác sĩ. Gợi ý: Gạo Lứt, Detox Juice, Thảm Yoga.';
              suggestions = [4, 1, 6]; 
          }

          result.style.display = 'block';
          result.style.background = color;
          result.innerHTML = `<strong>BMI: ${bmi}</strong> — ${status}<br><small>${advice}</small>`;
          result.style.animation = 'slideDown 0.5s';

          // CẢI TIẾN: Hiển thị gợi ý sản phẩm dưới dạng mini-card
          rec.innerHTML = '<strong>Gợi ý Sản phẩm:</strong> <div style="display:flex; gap:1rem; flex-wrap:wrap; justify-content:center; margin-top:10px">';
          rec.innerHTML += suggestions.map(id => {
              const p = productsData.find(x => x.id === id);
              if (!p) return '';
              return `
                  <div class="rec-card" onclick="app.addToCart(${p.id})">
                      <img src="${p.img}" alt="${p.name}" loading="lazy">
                      <small style="font-weight:600">${p.name.split(' ').slice(0,3).join(' ')}...</small>
                      <button onclick="event.stopPropagation(); app.addToCart(${p.id})">Thêm</button>
                  </div>`;
          }).join('');
          rec.innerHTML += '</div>';
          rec.style.display = 'block';


          if (currentUser && force) {
              const now = new Date();
              // Lưu height và weight dưới dạng số thực
              users[currentUser].bmi.push({bmi, weight: +els.weightInput.value, height: +els.heightInput.value, date: now.toISOString()});
              save('gf_users', users);
              showBMIHistory();
          }
      };

      const showBMIHistory = () => {
          const historyDiv = document.getElementById('bmiHistory');
          const listDiv = document.getElementById('bmiHistoryList');
          if (currentUser && users[currentUser] && users[currentUser].bmi.length > 0) {
              historyDiv.style.display = 'block';
              listDiv.innerHTML = users[currentUser].bmi
                  .slice(-5).reverse() // 5 mục gần nhất
                  .map(item => {
                      const date = new Date(item.date).toLocaleDateString('vi-VN');
                      return `<div class="bmi-item">
                          BMI: <strong>${item.bmi}</strong> (${item.height}cm, ${item.weight}kg) - ${date}
                      </div>`;
                  })
                  .join('');
          } else {
              historyDiv.style.display = 'none';
          }
      };

      // 7. Modal & UX
      const closeModal = (type) => {
          document.getElementById(type + 'Modal').style.display = 'none';
      };

      const showProduct = (id) => {
          const p = productsData.find(p => p.id === id);
          if (!p) return;
          const modal = document.getElementById('productModal');
          const content = document.getElementById('productModalContent');
          const ratingStars = '⭐'.repeat(Math.round(p.rating));
          const isOutOfStock = p.stock <= 0;

          content.innerHTML = `
              <span class="close-modal" onclick="app.closeModal('product')">&times;</span>
              <div style="text-align:center;padding:10px;">
                  <img src="${p.img}" alt="${p.name}" style="width:100%; max-width:200px; height:auto; border-radius:10px; margin-bottom:15px;">
                  <h2>${p.name}</h2>
                  <div class="rating" style="font-size:1.2rem;margin:10px 0;">${ratingStars} (${p.rating} / 5)</div>
                  <div class="price" style="font-size:1.8rem;color:var(--hot);margin-bottom:10px;">${p.price.toLocaleString('vi-VN')} VNĐ</div>
                  <p style="color:var(--gray);margin-bottom:15px;">Tồn kho: ${p.stock}</p>
                  <p>Mô tả chi tiết sản phẩm ${p.name}. Đây là sản phẩm hữu cơ, chất lượng cao, phù hợp với mọi chế độ ăn kiêng. Đặt hàng ngay để nhận ưu đãi!</p>
                  <button class="btn-primary" style="margin-top:20px; width:100%;" onclick="app.addToCart(${p.id}); app.closeModal('product');" ${isOutOfStock ? 'disabled' : ''}>
                      ${isOutOfStock ? 'Hết hàng' : '<i class="fas fa-cart-plus"></i> Thêm vào giỏ hàng'}
                  </button>
              </div>
          `;
          modal.style.display = 'flex';
      };

      const scrollToProduct = () => {
        document.getElementById('products').scrollIntoView({ behavior: 'smooth' });
      };

      const scrollIndicator = () => {
          const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
          const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
          const scrolled = (winScroll / height) * 100;
          document.getElementById('scrollIndicator').style.width = scrolled + "%";
      };

      const toggleMobileMenu = () => {
        document.getElementById('mobileMenu').classList.toggle('active');
      };
      
      const toggleTheme = () => {
          const html = document.documentElement;
          const currentTheme = html.dataset.theme;
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          
          html.dataset.theme = newTheme;
          localStorage.setItem('gf_theme', newTheme);

          // Cập nhật icon
          els.themeToggleBtn.querySelector('i').className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      };

      // 8. Authentication Functions
      // THÊM: Xử lý click nút Auth
      const handleAuthClick = () => {
          if (currentUser) {
              if (confirm('Bạn có muốn đăng xuất khỏi tài khoản không?')) {
                  logout();
              }
          } else {
              showLogin();
          }
      };

      const logout = () => {
          currentUser = null;
          localStorage.removeItem('gf_user');
          updateAuthUI();
          document.getElementById('bmiHistory').style.display = 'none';
          alert('Đã đăng xuất thành công.');
      };

      const showLogin = () => {
          const modal = document.getElementById('authModal');
          const content = document.getElementById('authModalContent');
          content.innerHTML = `
              <span class="close-modal" onclick="app.closeModal('auth')">&times;</span>
              <h2>Đăng nhập</h2>
              <div style="padding:20px;">
                  <input type="email" id="loginEmail" placeholder="Email" style="width:100%;padding:10px;margin-bottom:10px;border-radius:5px;border:1px solid #ddd;">
                  <input type="password" id="loginPass" placeholder="Mật khẩu" style="width:100%;padding:10px;margin-bottom:20px;border-radius:5px;border:1px solid #ddd;">
                  <button class="btn-primary" style="width:100%;" onclick="app.login()">Đăng nhập</button>
                  <p style="text-align:center;margin-top:15px;">Chưa có tài khoản? <a href="#" onclick="event.preventDefault(); app.showRegister()" style="color:var(--primary);font-weight:600;">Đăng ký ngay</a></p>
              </div>
          `;
          modal.style.display = 'flex';
      };

      const showRegister = () => {
          const modal = document.getElementById('authModal');
          const content = document.getElementById('authModalContent');
          content.innerHTML = `
              <span class="close-modal" onclick="app.closeModal('auth')">&times;</span>
              <h2>Đăng ký</h2>
              <div style="padding:20px;">
                  <input type="text" id="regName" placeholder="Họ và Tên" style="width:100%;padding:10px;margin-bottom:10px;border-radius:5px;border:1px solid #ddd;">
                  <input type="email" id="regEmail" placeholder="Email" style="width:100%;padding:10px;margin-bottom:10px;border-radius:5px;border:1px solid #ddd;">
                  <input type="password" id="regPass" placeholder="Mật khẩu" style="width:100%;padding:10px;margin-bottom:20px;border-radius:5px;border:1px solid #ddd;">
                  <button class="btn-primary" style="width:100%;" onclick="app.register()">Đăng ký</button>
                  <p style="text-align:center;margin-top:15px;">Đã có tài khoản? <a href="#" onclick="event.preventDefault(); app.showLogin()" style="color:var(--primary);font-weight:600;">Đăng nhập</a></p>
              </div>
          `;
          modal.style.display = 'flex';
      };

      // CẬP NHẬT: login/register
      const login = () => {
          const email = document.getElementById('loginEmail').value.trim();
          const pass = document.getElementById('loginPass').value;
          if (users[email] && users[email].pass === pass) {
              currentUser = email;
              localStorage.setItem('gf_user', email);
              alert(`Chào mừng, ${users[email].name.split(' ')[0]}!`);
              closeModal('auth');
              showBMIHistory();
              updateAuthUI(); // GỌI HÀM CẬP NHẬT UI
          } else alert('Sai email hoặc mật khẩu!');
      };

      const register = () => {
          const name = document.getElementById('regName').value.trim();
          const email = document.getElementById('regEmail').value.trim();
          const pass = document.getElementById('regPass').value;
          if (!name || !email || !pass) return alert('Vui lòng điền đầy đủ!');
          if (users[email]) return alert('Email đã tồn tại!');
          users[email] = { name, pass, bmi: [], orders: [] };
          save('gf_users', users);
          alert('Đăng ký thành công! Vui lòng đăng nhập.');
          showLogin();
      };
      
      // 9. Chatbot Functions
      const toggleChat = () => {
          const chatWindow = document.getElementById('chat-window');
          chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex';
      };
      
      // THÊM: Typing Indicator
      const showTypingIndicator = () => {
          const d = document.createElement('div');
          d.className = `message bot-message`;
          d.id = 'typingIndicator';
          d.innerHTML = '<strong>AI:</strong> <div class="typing-indicator"><span></span><span></span><span></span></div>';
          els.chatBody.appendChild(d);
          els.chatBody.scrollTop = els.chatBody.scrollHeight;
      };

      // CẬP NHẬT: addMsg
      const addMsg = (type, text) => {
          const d = document.createElement('div');
          d.className = `message ${type}-message`;
          if (type === 'bot') {
              d.innerHTML = `<strong>AI:</strong> ${text}`;
          } else {
              d.innerHTML = text;
          }
          els.chatBody.appendChild(d);
          els.chatBody.scrollTop = els.chatBody.scrollHeight;
          return d;
      };

      // CẬP NHẬT: sendMessage
      const sendMessage = () => {
          const msg = els.chatInput.value.trim();
          if (!msg) return;
          addMsg('user', msg);
          els.chatInput.value = '';
          
          showTypingIndicator(); // THÊM HIỆU ỨNG GÕ

          setTimeout(() => {
              const typingEl = document.getElementById('typingIndicator');
              if (typingEl) typingEl.remove();
              addMsg('bot', processBotResponse(msg));
          }, 900);
      };

      const processBotResponse = (msg) => {
          const lowerMsg = msg.toLowerCase();
          if (lowerMsg.includes('bmi')) {
              return 'Để tính BMI, bạn hãy truy cập mục "Tính BMI" ở đầu trang và nhập chiều cao, cân nặng. Chỉ số BMI sẽ được tính tự động!';
          }
          if (lowerMsg.includes('sản phẩm') || lowerMsg.includes('mua hàng')) {
              return 'GreenFit có các sản phẩm hữu cơ như Protein, Hạt Chia, và các dụng cụ tập luyện. Bạn có thể xem chi tiết trong mục "Sản phẩm"!';
          }
          if (lowerMsg.includes('detox')) {
              return 'Nước Detox Cải Bó Xôi của chúng tôi rất được ưa chuộng. Bạn có muốn thêm vào giỏ hàng ngay không? (Mã SP: 1)';
          }
          if (lowerMsg.includes('giá')) {
              return 'Giá sản phẩm dao động từ 45k đến 750k VNĐ. Bạn có thể dùng bộ lọc giá trong mục "Sản phẩm" để tìm kiếm dễ dàng hơn.';
          }
          if (lowerMsg.includes('tên')) {
              return `Tôi là GreenFit AI, trợ lý ảo về sức khỏe và lối sống xanh của bạn.`;
          }
          if (lowerMsg.includes('chào') || lowerMsg.includes('hello')) {
              return 'Xin chào! Tôi có thể giúp bạn tìm sản phẩm hay tư vấn dinh dưỡng không?';
          }
          return 'Tôi chưa hiểu câu hỏi của bạn lắm. Hãy hỏi về BMI, sản phẩm, hoặc dinh dưỡng nhé!';
      };

      // 10. PWA Registration
      const registerSW = () => {
          if ('serviceWorker' in navigator) {
              const swCode = `
                  self.addEventListener('install', (event) => {
                      console.log('Service Worker installed');
                      event.waitUntil(
                          caches.open('gf-cache-v1').then((cache) => {
                              return cache.addAll([
                                  './',
                                  'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css',
                                  'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap',
                                  // Thêm các tài nguyên tĩnh khác nếu cần
                              ]);
                          })
                      );
                  });

                  self.addEventListener('fetch', (event) => {
                      event.respondWith(
                          caches.match(event.request).then((response) => {
                              return response || fetch(event.request);
                          })
                      );
                  });
              `;
              const blob = new Blob([swCode], {type: 'application/javascript'});
              const url = URL.createObjectURL(blob);
              navigator.serviceWorker.register(url);
          }
      };

      // 11. Initialization
      document.addEventListener('DOMContentLoaded', () => {
          // Khởi tạo Theme
          const theme = localStorage.getItem('gf_theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
          document.documentElement.dataset.theme = theme;
          els.themeToggleBtn.querySelector('i').className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
          
          updateCartUI();
          renderProducts(productsData);
          registerSW();
          showBMIHistory();
          updateAuthUI(); // KHỞI TẠO NÚT ĐĂNG NHẬP/TÊN NGƯỜI DÙNG

          // Gán listeners
          els.heightInput.addEventListener('input', autoCalcBMI);
          els.weightInput.addEventListener('input', autoCalcBMI);
          els.searchInput.addEventListener('input', delayedFilter);
          els.priceFilter.addEventListener('change', applyFilters);
          els.ratingFilter.addEventListener('change', applyFilters);
      });

      // 12. Public API
      return {
          addToCart, updateQty, removeFromCart, toggleCart, checkout, showProduct, closeModal,
          filterByCategory, applyFilters, delayedFilter, clearFilters,
          calculateBMI, showBMIHistory, scrollToProduct,
          toggleChat, sendMessage, toggleTheme, toggleMobileMenu, scrollIndicator,
          showLogin, showRegister, login, register, handleAuthClick, logout // THÊM handleAuthClick, logout
      };
    })();

    window.app = app;
  </script>
</body>
</html>